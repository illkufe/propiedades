{% extends 'index.html' %}
{% block section %}

{% load avatar_tags %}
{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row animated fadeInRight">
		<div class="col-md-3">
			<div class="ibox float-e-margins">
				<div class="ibox-title">
					<h5>Perfil</h5>
				</div>
				<div>
					<div class="ibox-content border-left-right">
						<div class="text-center">
							<img src="{% avatar_url request.user %}" class="img-circle img-profile" alt="" width="120" height="120">

							<form id="form-update-avatar" action="/avatar/add/" method="POST" enctype="multipart/form-data">
								{% csrf_token %}
								<input id="id_avatar" class="hide" name="avatar" type="file" accept="image/*">
							</form>
						</div>
					</div>

					<div class="ibox-content profile-content text-center">

						<h4><strong>{{ request.user.first_name }} {{ request.user.last_name }}</strong></h4>

						<p><i class="fa fa-briefcase"></i> &nbsp;&nbsp;{{ request.user.userprofile.cargo }}</p>
						<p><i class="fa fa-envelope-o"></i> &nbsp;&nbsp;{{ request.user.email }}</p>
						<p class="m-b-lg"><i class="fa fa-map-marker"></i> &nbsp;&nbsp;{{ request.user.userprofile.direccion }}</p>
						
						<div class="row">
							<div class="col-md-12">
								<button type="button" class="btn btn-primary btn-sm btn-block" id="btn-change-avatar"><i class="fa fa-image"></i> Editar Avatar</button>
							</div>
							
							<div class="col-md-12">
								<button type="button" class="btn btn-default btn-sm btn-block m-t-sm" id="btn-update-password" data-toggle="modal" data-target="#m-update-password"><i class="fa fa-key"></i> Editar Contraseña</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-md-9">
			<div class="ibox float-e-margins">

				<div class="ibox-title">
					<h5>Actualizar Información General</h5>
					<div class="ibox-tools">
						<a class="collapse-link">
							<i class="fa fa-chevron-up"></i>
						</a>
					</div>
				</div>
				<div class="ibox-content">

					<div class="row">
						<div class="col-sm-12">

							<form id="f-user-update" role="form" action="{% url 'accounts:usuario_update' user.userprofile.id %}" method="post">
								{% csrf_token %}


								<div class="row">

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.first_name.help_text }}" ></i>
											{{ form_profile.first_name.label_tag }}
										</span>
										{{ form_profile.first_name }}
										<div class="container-error">
											{{ form_profile.first_name.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.last_name.help_text }}" ></i>
											{{ form_profile.last_name.label_tag }}
										</span>
										{{ form_profile.last_name }}
										<div class="container-error">
											{{ form_profile.last_name.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.email.help_text }}" ></i>
											{{ form_profile.email.label_tag }}
										</span>
										{{ form_profile.email }}
										<div class="container-error">
											{{ form_profile.email.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.username.help_text }}" ></i>
											{{ form_profile.username.label_tag }}
										</span>
										{{ form_profile.username }}
										<div class="container-error">
											{{ form_profile.username.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.rut.help_text }}" ></i>
											{{ form_profile.rut.label_tag }}
										</span>
										{{ form_profile.rut }}
										<div class="container-error">
											{{ form_profile.rut.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.ciudad.help_text }}" ></i>
											{{ form_profile.ciudad.label_tag }}
										</span>
										{{ form_profile.ciudad }}
										<div class="container-error">
											{{ form_profile.ciudad.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.comuna.help_text }}" ></i>
											{{ form_profile.comuna.label_tag }}
										</span>
										{{ form_profile.comuna }}
										<div class="container-error">
											{{ form_profile.comuna.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.direccion.help_text }}" ></i>
											{{ form_profile.direccion.label_tag }}
										</span>
										{{ form_profile.direccion }}
										<div class="container-error">
											{{ form_profile.direccion.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.cargo.help_text }}" ></i>
											{{ form_profile.cargo.label_tag }}
										</span>
										{{ form_profile.cargo }}
										<div class="container-error">
											{{ form_profile.cargo.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3 hide">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.tipo.help_text }}" ></i>
											{{ form_profile.tipo.label_tag }}
										</span>
										{{ form_profile.tipo }}
										<div class="container-error">
											{{ form_profile.tipo.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-3 hide">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.cliente.help_text }}" ></i>
											{{ form_profile.cliente.label_tag }}
										</span>
										{{ form_profile.cliente }}
										<div class="container-error">
											{{ form_profile.cliente.errors|striptags }}
										</div>
									</div>

									<div class="form-group col-sm-9">
										<span>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_profile.descripcion.help_text }}" ></i>
											{{ form_profile.descripcion.label_tag }}
										</span>
										{{ form_profile.descripcion }}
										<div class="container-error">
											{{ form_profile.descripcion.errors|striptags }}
										</div>
									</div>
								</div>
								
								<p class="m-t">el cliente es obligatorio cuando se escoje el tipo de usuario "cliente"</p>
								<p class="m-b-md">(*) campos obligatorios</p>
								
								<button type="button" id="btn-form-user" class="btn btn-w-m btn-sm btn-primary pull-right m-l">Actualizar</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-md-12">
			<div class="ibox float-e-margins">

				<div class="ibox-title">
					<h5>Actualizar Información Owncloud</h5>
					<div class="ibox-tools">
						<a class="collapse-link">
							<i class="fa fa-chevron-up"></i>
						</a>
					</div>
				</div>
				<div class="ibox-content">
					<form id="f-update-owncloud" action="{% url 'accounts:update_owncloud' %}" role="form" method="post">
						{% csrf_token %}

						<div class="row">
							<div class="col-sm-12">
								<div class="form-group col-sm-12">
									<span>
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_owncloud.url.help_text }}" ></i>
										{{ form_owncloud.url.label_tag }}
									</span>
									{{ form_owncloud.url }}
									<div class="container-error">
										{{ form_owncloud.url.errors }}
									</div>
								</div>

								<div class="form-group col-sm-6">
									<span>
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_owncloud.usuario.help_text }}" ></i>
										{{ form_owncloud.usuario.label_tag }}
									</span>
									{{ form_owncloud.usuario }}
									<div class="container-error">
										{{ form_owncloud.usuario.errors }}
									</div>
								</div>

								<div class="form-group col-sm-6">
									<span>
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form_owncloud.password.help_text }}" ></i>
										{{ form_owncloud.password.label_tag }}
									</span>
									{{ form_owncloud.password }}
									<div class="container-error">
										{{ form_owncloud.password.errors }}
									</div>
								</div>

								<div class="col-xs-12">
									<p class="m-b-md">(*) campos obligatorios</p>
								</div>

							</div>
						</div>

						<div class="row">
							<div class="col-sm-12">
								<button type="button" id="btn-update-owncloud" class="btn btn-w-m btn-sm btn-primary pull-right">Actualizar</button>
							</div>
						</div>
					</form>

				</div>
			</div>
		</div>
	</div>
</div>


<!-- modal: actualizar contraseña -->
<div class="modal fade" id="m-update-password" tabindex="-1" role="dialog"  aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h4 class="modal-title">Actualizar Contraseña</h4>
			</div>
			<form id="f-update-password" action="{% url 'accounts:update_password' %}" role="form" method="post">
				{% csrf_token %}

				<div class="modal-body">
					<div class="row">

						<div class="form-group col-sm-12">
							<span>
								<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="" data-original-title="ingresar nueva contraseña, 8 caracteres mínimo"></i>
								{{ form_password.password_actual.label_tag }}
							</span>
							{{ form_password.password_actual }}
							<div class="container-error">
								{{ form_password.password_actual.errors }}
							</div>
						</div>

						<div class="form-group col-sm-12">
							<span>
								<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="" data-original-title="ingresar nueva contraseña, 8 caracteres mínimo"></i>
								{{ form_password.password_nueva.label_tag }}
							</span>
							{{ form_password.password_nueva }}
							<div class="container-error">
								{{ form_password.password_nueva.errors }}
							</div>
						</div>

						<div class="form-group col-sm-12">
							<span>
								<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="" data-original-title="repetir contraseña ingresada"></i>
								{{ form_password.password_copia.label_tag }}
							</span>
							{{ form_password.password_copia }}
							<div class="container-error">
								{{ form_password.password_copia.errors }}
							</div>
						</div>
						
						<div class="col-xs-12">
							<p class="m-b-sm">(*) campos obligatorios</p>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-w-m btn-sm btn-default" data-dismiss="modal">CANCELAR</button>
					<button type="submit" class="btn btn-w-m btn-sm btn-primary pull-right">GUARDAR</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

$(document).ready(function(){

	initialize()
	submit_form_password()

})

function initialize(){

	

	$('#btn-update-owncloud').click(submit_form_owncloud)
	$('#btn-form-user').click(submit_form_user)

	$("input[name=avatar]").change(function(){
		$('#form-update-avatar').submit();
	});

	$("#btn-change-avatar").click(function(){
		$("input[name=avatar]").trigger('click');
	});

	$("#btn-update-password").click(function(){
		form_clear_errors('#f-update-password')
		form_clear_fields('#f-update-password')
	});

	$('[data-toggle="tooltip"]').tooltip();
}

function submit_form_user(){

	$('#f-user-update').ajaxSubmit({
		dataType: 'json',
		success: function(response){

			form_clear_errors('#f-user-update')

			var notification = {
				'toast_type'	: response.status == true ? 'success' : 'error',
				'toast_title' 	: response.status == true ? 'Éxito' : 'Error',
				'toast_text' 	: response.message,
			}

			notification_toast(notification)

		},
		error: function(data, textStatus, jqXHR) {

			form_clear_errors('#f-user-update')
			form_put_errors($.parseJSON(data.responseText))
		}
	});
}


function submit_form_owncloud(){

	$('#f-update-owncloud').ajaxSubmit({
		dataType: 'json',
		success: function(response){

			form_clear_errors('#f-update-owncloud')

			var notification = {
				'toast_type'	: response.status == true ? 'success' : 'error',
				'toast_title' 	: response.status == true ? 'Éxito' : 'Error',
				'toast_text' 	: response.message,
			}

			notification_toast(notification)

		},
		error: function(data, textStatus, jqXHR) {
			form_clear_errors('#f-update-owncloud')
			form_put_errors($.parseJSON(data.responseText))
		}
	});
}

function submit_form_password(){

	$.validator.addMethod("notEqualTo", function (value, element) {
		password_actual = $('#f-update-password input[name="password_actual"]').val()
		password_nueva 	= $('#f-update-password input[name="password_nueva"]').val()

		if (password_actual == password_nueva) {
			return false;
		}
		else{
			return true;
		}
	}, 'Contraseña igual a la actual');
	
	$("#f-update-password").validate({
		rules: {
			password_actual: {
				required: true,
				minlength: 8,
			},
			password_nueva: {
				required: true,
				minlength: 8,
				notEqualTo: true,
			},
			password_copia: {
				required: true,
				minlength: 8,
				equalTo: "#id_password_nueva",
			},
		},
		messages: {
			password_actual: {
				required: "campo requerido",
				minlength: "Mínimo 8 caracteres",
			},
			password_nueva: {
				required: "campo requerido",
				minlength: "Mínimo 8 caracteres",
			},
			password_copia: {
				required: "campo requerido",
				minlength: "Mínimo 8 caracteres",
				equalTo: "Las contraseñas no coinciden",
			},
		},
		errorPlacement: function(error, element) {
			element.closest(".form-group").find('.container-error').html('')
			error.appendTo(element.closest(".form-group").find('.container-error'));
		},
		submitHandler: function(form) {
			$('#f-update-password').ajaxSubmit({
				dataType: 'json',
				success: function(response){

					form_clear_fields('#f-update-password')
					form_clear_errors('#f-update-password')

					var notification = {
						'toast_type'	: response.status == true ? 'success' : 'error',
						'toast_title' 	: response.status == true ? 'Éxito' : 'Error',
						'toast_text' 	: response.message,
					}

					notification_toast(notification)
					$('#m-update-password').modal('hide')

				},
				error: function(data, textStatus, jqXHR) {
					form_clear_errors('#f-update-password')
					form_put_errors($.parseJSON(data.responseText))
				}
			});
		}
	}) 
}

</script>

{% endblock scripts %}
