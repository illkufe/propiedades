# activos/urls.py

url(r'^medidores/list$', views.MedidorList.as_view(), name='medidor_list'),
url(r'^medidores/new$', views.MedidorNew.as_view(), name='medidor_new'),
url(r'^medidores/delete/(?P<pk>\d+)$', views.MedidorDelete.as_view(), name='medidor_delete'),
url(r'^medidores/update/(?P<pk>\d+)$', views.MedidorUpdate.as_view(), name='medidor_update'),


# activos/views.py

from datetime import datetime, timedelta
import calendar

class AjaxableResponseMixinMedidor(object):

	template_name = 'viewer/activos/medidor_new.html'
	form_class = MedidorForm
	success_url = '/medidores/list'

	def form_invalid(self, form):
		response = super(AjaxableResponseMixinMedidor, self).form_invalid(form)
		if self.request.is_ajax():
			return JsonResponse(form.errors, status=400)
		else:
			return response

			def form_valid(self, form):

				obj = form.save(commit=False)
				obj.activo_id = self.kwargs['activo_id']
				obj.save()

				response = super(AjaxableResponseMixinMedidor, self).form_valid(form)
				if self.request.is_ajax():
					data = {
					'pk': 'self.object.pk',
					}
					return JsonResponse(data)
				else:
					return response

					class MedidorNew(AjaxableResponseMixinMedidor, FormView):

						def get_context_data(self, **kwargs):
							
							context = super(MedidorNew, self).get_context_data(**kwargs)
							context['title'] = 'Activos'
							context['subtitle'] = 'Medidor'
							context['name'] = 'Nuevo'
							context['href'] = 'medidores'
							context['accion'] = 'create'
							context['activo_id']	= self.kwargs['activo_id']

							return context
							
							class MedidorList(ListView):
								model = Medidor
								template_name = 'viewer/activos/medidor_list.html'

								def get_context_data(self, **kwargs):
									context = super(MedidorList, self).get_context_data(**kwargs)
									context['title'] = 'Activos'
									context['subtitle'] = 'Medidor'
									context['name'] = 'Lista'
									context['href'] = 'medidores'

									return context

									def get_queryset(self):

										user 		= User.objects.get(pk=self.request.user.pk)
										profile 	= UserProfile.objects.get(user=user)
										activos 	= Activo.objects.filter(empresa_id=profile.empresa_id).values_list('id', flat=True)

										queryset 	= Medidor.objects.filter(activo_id__in=activos, visible=True)

										return queryset

										class MedidorDelete(DeleteView):
											model = Medidor
											success_url = reverse_lazy('/locales/list')

											def delete(self, request, *args, **kwargs):
												self.object = self.get_object()
												self.object.visible = False
												self.object.save()
												payload = {'delete': 'ok'}
												return JsonResponse(payload, safe=False)

												class MedidorUpdate(UpdateView):

													model = Medidor
													form_class = MedidorForm
													template_name = 'viewer/activos/medidor_new.html'
													success_url = '/medidores/list'

													def get_context_data(self, **kwargs):
														
														context = super(MedidorUpdate, self).get_context_data(**kwargs)
														context['title'] = 'Activos'
														context['subtitle'] = 'Medidor'
														context['name'] = 'Editar'
														context['href'] = 'medidores'
														context['accion'] = 'update'
														return context


# viewer/templates/activos/activo_medidor_new.html

<div class="ibox-title">
<h5>Medidores</h5>
</div>

<div class="ibox-content">
<br>
<div class="row">
<div class="col-sm-12">

{{ form_medidor.management_form }}
{% for form in form_medidor %}
{% for hidden in form.hidden_fields %}
{{ hidden }}
{% endfor %}
{% endfor %}

<button type="button" class="btn btn-primary btn-xs pull-right" onclick="agregar_periodo_arriendo()"><i class="fa fa-plus"></i> Nuevo Medidor</button>
<table id="tabla-medidor" class="table">
<thead>
{% for form in form_medidor %}
{% if forloop.first %}
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.nombre.help_text }}" ></i>
{{ form.nombre.label_tag }}
</th>
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.numero_rotulo.help_text }}" ></i>
{{ form.numero_rotulo.label_tag }}
</th>
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia.help_text }}" ></i>
{{ form.potencia.label_tag }}
</th>
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_presente.help_text }}" ></i>
{{ form.potencia_presente.label_tag }}
</th>
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_fuera.help_text }}" ></i>
{{ form.potencia_fuera.label_tag }}
</th>
<th>
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.medidor_tipo.help_text }}" ></i>
{{ form.medidor_tipo.label_tag }}
</th>
<th></th>
{% endif %}
{% endfor %}
</thead>
<tbody>
{% for form in form_medidor %}
<tr>
<td>

<div class="form-group">
{{ form.nombre }}
<div class="container-error">
{{ form.nombre.errors }}
</div>
</div>
</td>
<td>

<div class="form-group">
{{ form.numero_rotulo }}
<div class="container-error">
{{ form.numero_rotulo.errors }}
</div>
</div>
</td>
<td>

<div class="form-group">

{{ form.potencia }}
<div class="container-error">
{{ form.potencia.errors }}
</div>
</div>
</td>
<td>

<div class="form-group">

{{ form.potencia_presente }}
<div class="container-error">
{{ form.potencia_presente.errors }}
</div>
</div>
</td>
<td>
<div class="form-group">

{{ form.potencia_fuera }}
<div class="container-error">
{{ form.potencia_fuera.errors }}
</div>
</div>
</td>
<td class="text-center">

<div class="form-group">

{{ form.medidor_tipo }}
<div class="container-error">
{{ form.medidor_tipo.errors }}
</div>
</div>
</td>
<td class="text-center delete">

<div class="form-group text-center">
{{ form.DELETE }}
<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete_child(this, 'Medidor')"><i class="fa fa-trash"></i></a>
</div>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
<br>
<a href="/activos/list"><button class="btn btn-w-m btn-sm btn-default" type="button">CANCELAR</button></a>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">GUARDAR Y SALIR</button>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button" style="margin-right: 15px;" onclick="enviar_form('{{accion}}')">GUARDAR Y SEGUIR</button>
</div>


# activos/forms.py

class MedidorForm(forms.ModelForm):

	class Meta:
		model 	= Medidor
		fields 	= ['nombre','numero_rotulo','potencia','potencia_presente','potencia_fuera','medidor_tipo']

		widgets = {
		'nombre'			: forms.TextInput(attrs={'class': 'form-control'}),
		'numero_rotulo'		: forms.TextInput(attrs={'class': 'form-control'}),
		'potencia'			: forms.NumberInput(attrs={'class': 'form-control'}),
		'potencia_presente'	: forms.NumberInput(attrs={'class': 'form-control'}),
		'potencia_fuera'	: forms.NumberInput(attrs={'class': 'form-control'}),
		'medidor_tipo'		: forms.Select(attrs={'class': 'form-control'}),
		}

		error_messages = {
		'nombre' 		: {'required': 'Este campo es requerido'},
		'numero_rotulo' : {'required': 'Este campo es requerido'},
		'medidor_tipo' 	: {'required': 'Este campo es requerido'},
		}

		help_texts = {
		'nombre'			: '...',
		'numero_rotulo'		: '...',
		'potencia'			: '...',
		'potencia_presente'	: '...',
		'potencia_fuera'	: '...',
		'medidor_tipo'		: '...',
		}

		labels = {
		'numero_rotulo'	: 'Número Rótulo',
		'medidor_tipo'	: 'Tipo de Medidor',
		}

		MedidorFormSet 	= inlineformset_factory(Activo, Medidor, form=MedidorForm, extra=1, can_delete=True)


# viewer/templates/viewer/contratos/contrato_new.html

<div class="ibox-title">
<h5>Nuevo Tipo de Contrato</h5>
</div>

<div class="ibox-content">
<div class="row">
<div class="col-xs-12">
<div>

<ul class="nav nav-tabs" role="tablist">
<li role="presentation" class="active"><a href="#page-1" aria-controls="page-1" role="tab" data-toggle="tab">Información General</a></li>
<li role="presentation"><a href="#page-2" aria-controls="page-2" role="tab" data-toggle="tab">Conceptos</a></li>
<li role="presentation"><a href="#page-3" aria-controls="page-3" role="tab" data-toggle="tab">Prorroga</a></li>
<li role="presentation"><a href="#page-4" aria-controls="page-4" role="tab" data-toggle="tab">Clausulas Conceptos</a></li>
<li role="presentation"><a href="#page-5" aria-controls="page-5" role="tab" data-toggle="tab">Poliza</a></li>
</ul>

<div class="tab-content">
<div role="tabpanel" class="tab-pane active" id="page-1">
<br>
<br>

<form id="form-contrato-new" role="form" action="" method="post">
{% csrf_token %}
<div class="row">

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.metros_local.help_text }}" ></i>
{{ form.metros_local.label_tag }}
{{ form.metros_local }}
<div class="container-error">
{{ form.metros_local.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.metros_otros.help_text }}" ></i>
{{ form.metros_otros.label_tag }}
{{ form.metros_otros }}
<div class="container-error">
{{ form.metros_otros.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.arriendo_local.help_text }}" ></i>
{{ form.arriendo_local.label_tag }}
{{ form.arriendo_local }}
<div class="container-error">
{{ form.arriendo_local.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.arriendo_otros.help_text }}" ></i>
{{ form.arriendo_otros.label_tag }}
{{ form.arriendo_otros }}
<div class="container-error">
{{ form.arriendo_otros.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.arriendo_porcentual.help_text }}" ></i>
{{ form.arriendo_porcentual.label_tag }}
{{ form.arriendo_porcentual }}
<div class="container-error">
{{ form.arriendo_porcentual.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.reajuste_porcentaje.help_text }}" ></i>
{{ form.reajuste_porcentaje.label_tag }}
{{ form.reajuste_porcentaje }}
<div class="container-error">
{{ form.reajuste_porcentaje.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.reajuste_meses.help_text }}" ></i>
{{ form.reajuste_meses.label_tag }}
{{ form.reajuste_meses }}
<div class="container-error">
{{ form.reajuste_meses.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.fondo_promocion.help_text }}" ></i>
{{ form.fondo_promocion.label_tag }}
{{ form.fondo_promocion }}
<div class="container-error">
{{ form.fondo_promocion.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.cuota_promocion.help_text }}" ></i>
{{ form.cuota_promocion.label_tag }}
{{ form.cuota_promocion }}
<div class="container-error">
{{ form.cuota_promocion.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.gasto_comun_local.help_text }}" ></i>
{{ form.gasto_comun_local.label_tag }}
{{ form.gasto_comun_local }}
<div class="container-error">
{{ form.gasto_comun_local.errors }}
</div>
</div>

<div class="form-group col-sm-3">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.gasto_comun_otros.help_text }}" ></i>
{{ form.gasto_comun_otros.label_tag }}
{{ form.gasto_comun_otros }}
<div class="container-error">
{{ form.gasto_comun_otros.errors }}
</div>
</div>
</div>
<br>

<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">GUARDAR Y SALIR</button>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button" style="margin-right: 15px;" onclick="enviar_form('{{accion}}')">GUARDAR Y SEGUIR</button>
<a href="/contratos-tipo/list"><button class="btn btn-w-m btn-sm btn-success pull-right" type="button" style="margin-right: 15px;">CANCELAR</button></a>
</form>
</div>

<div role="tabpanel" class="tab-pane" id="page-2"></div>

<div role="tabpanel" class="tab-pane" id="page-3">
<br>
<br>
<table id="tabla-formulas" class="table table-striped">
<thead> 
<tr> 
<th>Nº Secuencia</th>
<th>F.Inicio</th>
<th>F.Termino</th>
<th>Nº Meses</th>
<th>F. Apertura</th>
</tr>
</thead>
<tbody>
<tr>
<td><input type="text"></td>
<td><input type="text"></td>
<td><input type="text"></td>
<td><input type="text"></td>
<td><input type="text"></td>
</tr>
</tbody> 
</table>
<br>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button">GUARDAR</button>
</div>

<div role="tabpanel" class="tab-pane" id="page-4">
<br>
<br>
<table id="tabla-formulas" class="table table-striped">
<thead>
<tr>
									<th>#</th>
									<th>Tipo</th>
									<th>Aplica en</th>
									<th>Concepto</th>
									<th>Factor</th>
									<th>Moneda</th>
									<th>F.Inicio</th>
									<th>F.Termino</th>
									</tr>
									</thead>
									<tbody>
									<tr>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									</tr>
									</tbody>
									</table>
									<br>
									<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button">GUARDAR</button>
									</div>

									<div role="tabpanel" class="tab-pane" id="page-5">
									<br>
									<br>
									<table id="tabla-formulas" class="table table-striped">
									<thead>
									<tr>
									<th>Nº Poliza</th>
									<th>Compañia</th>
									<th>Moneda</th>
									<th>Monto Asegurado</th>
									<th>Valor Prima</th>
									<th>F.Vigencia</th>
									<th>F.Vencimiento</th>
									<th>Nº Cuotas</th>
									<th>Nº Endoso</th>
									<th>F.Inicio</th>
									<th>Nº Cuotas</th>
									<th>Estado</th>
									</tr>
									</thead>
									<tbody>
									<tr>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									<td><input type="text"></td>
									</tr>
									</tbody>
									</table>
									<br>
									<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button">GUARDAR</button>
									</div>
									</div>
									</div>
									</div>
									</div>
									</div>


# administrador/models.py

class Unidad_Negocio(models.Model):

	# atributos (generales)
	nombre      = models.CharField(max_length=250)
	codigo      = models.CharField(max_length=250, blank=True)
	descripcion = models.TextField(blank=True)
	
	# atributos (por defecto)
	visible     = models.BooleanField(default=True)
	creado_en   = models.DateTimeField(auto_now=True)

	# relaciones
	empresa = models.ForeignKey(Empresa)

	def __str__(self):
		return self.nombre


# administrador/urls.py

url(r'^unidades-negocio/list$', views.UnidadNegocioList.as_view(), name='unidad_negocio_list'),
url(r'^unidades-negocio/new$', views.UnidadNegocioNew.as_view(), name='unidad_negocio_new'),
url(r'^unidades-negocio/delete/(?P<pk>\d+)$', views.UnidadNegocioDelete.as_view(), name='unidad_negocio_delete'),
url(r'^unidades-negocio/update/(?P<pk>\d+)$', views.UnidadNegocioUpdate.as_view(), name='unidad_negocio_update'),

# administrador/views.py

class UnidadNegocioMixin(object):

	template_name = 'viewer/configuracion/unidad_negocio_new.html'
	form_class = UnidadNegocioForm
	success_url = '/unidades-negocio/list'

	def form_invalid(self, form):
		response = super(UnidadNegocioMixin, self).form_invalid(form)
		if self.request.is_ajax():
			return JsonResponse(form.errors, status=400)
		else:
			return response

			def form_valid(self, form):

				user 	= User.objects.get(pk=self.request.user.pk)
				profile = UserProfile.objects.get(user=user)

				obj = form.save(commit=False)
				obj.empresa_id = profile.empresa_id
				obj.save()

				response = super(UnidadNegocioMixin, self).form_valid(form)
				if self.request.is_ajax():
					data = {
					'pk': 'self.object.pk',
					}
					return JsonResponse(data)
				else:
					return response

					class UnidadNegocioNew(UnidadNegocioMixin, FormView):

						def get_context_data(self, **kwargs):
							
							context = super(UnidadNegocioNew, self).get_context_data(**kwargs)
							context['title'] = 'Unidades de Negocio'
							context['subtitle'] = 'Unidad de Negocio'
							context['name'] = 'Nueva'
							context['href'] = 'unidades-negocio'
							context['accion'] = 'create'

							return context

							class UnidadNegocioList(ListView):
								model = Unidad_Negocio
								template_name = 'viewer/configuracion/unidad_negocio_list.html'

								def get_context_data(self, **kwargs):
									context = super(UnidadNegocioList, self).get_context_data(**kwargs)
									context['title'] = 'Unidades de Negocio'
									context['subtitle'] = 'Unidad de Negocio'
									context['name'] = 'Lista'
									context['href'] = 'unidades-negocio'

									return context

									def get_queryset(self):

										user 		= User.objects.get(pk=self.request.user.pk)
										profile 	= UserProfile.objects.get(user=user)
										queryset 	= Unidad_Negocio.objects.filter(empresa=profile.empresa, visible=True)

										return queryset

										class UnidadNegocioDelete(DeleteView):
											model = Unidad_Negocio
											success_url = reverse_lazy('/unidades-negocio/list')

											def delete(self, request, *args, **kwargs):
												self.object = self.get_object()
												self.object.visible = False
												self.object.save()
												payload = {'delete': 'ok'}
												return JsonResponse(payload, safe=False)

												class UnidadNegocioUpdate(UpdateView):

													model = Unidad_Negocio
													form_class = UnidadNegocioForm
													template_name = 'viewer/configuracion/unidad_negocio_new.html'
													success_url = '/unidades-negocio/list'

													def get_context_data(self, **kwargs):
														
														context = super(UnidadNegocioUpdate, self).get_context_data(**kwargs)
														context['title'] = 'Unidades de Negocio'
														context['subtitle'] = 'Unidad de Negocio'
														context['name'] = 'Editar'
														context['href'] = 'unidades-negocio'
														context['accion'] = 'update'
														return context


# administrador/forms.py

class UnidadNegocioForm(forms.ModelForm):

	class Meta:
		model 	= Unidad_Negocio
		fields 	= ['nombre', 'codigo', 'descripcion']

		widgets = {
		'nombre'		: forms.TextInput(attrs={'class': 'form-control'}),
		'codigo'		: forms.TextInput(attrs={'class': 'form-control'}),
		'descripcion'	: forms.Textarea(attrs={'class': 'form-control', 'rows':'1'}),
		}

		error_messages = {
		'nombre' : {'required': 'Este campo es requerido'},
		'codigo' : {'required': 'Este campo es requerido'},
		}


# viewer/templates/viewer/configuracion/unidad_negocio_list.html

{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
<div class="row">
<div class="col-lg-12">
<div class="ibox float-e-margins">
<div class="ibox-title">
<h5>Lista de Unidades de Negocio</h5>
<div class="ibox-tools">
<a href="/unidades-negocio/new">
<button type="button" class="btn btn-primary btn-xs"><i class="fa fa-plus"></i> nueva unidad de negocio</button>
</a>
</div>
</div>
<div class="ibox-content">
<br>
<div class="table-responsive">
<table id="tabla-unidades-negocio" class="table table-striped table-bordered table-hover dataTables-example" >
<thead></thead>
<tbody>
{% for item in object_list %}
<tr>
<td>{{ item.id }}</td>
<td>{{ item.codigo }}</td>
<td>{{ item.nombre }}</td>
<td>{{ item.descripcion }}</td>

<td class="text-center">
<a class="btn btn-edit btn-bitbucket" href='{% url "unidad_negocio_update" item.id %}'><i class="fa fa-edit"></i></a>
<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete(this, {{item.id}}, 'unidades-negocio', 'tabla-unidades-negocio', 'Unidad de Negocio')"><i class="fa fa-trash"></i></a>
<a class="btn btn-view btn-bitbucket"><i class="fa fa-eye"></i></a>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

$(document).ready(function(){

	var tabla_unidades_negocio = []

	var columns = [
	{		
	'data': 'id',
	'title': 'ID',
	'visible': false,
	},
	{
	'width': '15%',
	'data': 'codigo',
	'title': 'Código',
	},
	{
	'width': '15%',
	'data': 'nombre',
	'title': 'Nombre',
	},
	{
	'width': '55%',
	'data': 'descripcion',
	'title': 'Descripción',
	},
	{
	'width': '15%',
	'data': 'options',
	'orderable': false,
	}]

	tabla_unidades_negocio = load_table('#tabla-unidades-negocio', columns, {})

	});

</script>

{% endblock scripts %}


# viewer/templates/viewer/configuracion/unidad_negocio_new.html

{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
<div class="row">
<div class="col-lg-12">
<div class="ibox float-e-margins">
<div class="ibox-title">
<h5>Nueva Unidad de Negocio</h5>
</div>
<div class="ibox-content">
<div class="row">
<div class="col-sm-12">

<form id="form-medidor-new" role="form" action="" method="post">
{% csrf_token %}

<div class="row">
{% for field in form %}
<div class="form-group col-sm-4">
<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ field.help_text }}" ></i>
{{ field.label_tag }}
{{ field }}
<div class="container-error">
{{ field.errors }}
</div>
</div>
{% endfor %}
</div>
<br>

<a href="/unidades-negocio/list"><button class="btn btn-w-m btn-sm btn-default" type="button">CANCELAR</button></a>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">GUARDAR Y SALIR</button>
<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button" style="margin-right: 15px;" onclick="guardar_formulario('{{accion}}', 'form-medidor-new')">GUARDAR Y SEGUIR</button>

</form>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

$(document).ready(function(){
	})

</script>
{% endblock scripts %}

# activos/models.py

class Medidor_Tipo(models.Model):

	# atributos (generales)
	nombre 		= models.CharField(max_length=250)
	codigo 		= models.CharField(max_length=250, blank=True)	
	descripcion = models.TextField(blank=True)

	# atributos (por defecto)
	visible 	= models.BooleanField(default=True)
	creado_en 	= models.DateTimeField(auto_now=True)

	def __str__(self):
		return self.nombre

		class Medidor(models.Model):

# atributos (generales)
nombre 				= models.CharField(max_length=250)
numero_rotulo 		= models.CharField(max_length=250)
potencia			= models.FloatField(default=0, null=True, blank=True)
potencia_presente	= models.FloatField(default=0, null=True, blank=True)
potencia_fuera		= models.FloatField(default=0, null=True, blank=True)
estado 				= models.BooleanField(default=False)

# atributos (por defecto)
visible 			= models.BooleanField(default=True)
creado_en 			= models.DateTimeField(auto_now=True)

# relaciones
activo 			= models.ForeignKey(Activo)
medidor_tipo 	= models.ForeignKey(Medidor_Tipo)

def __str__(self):
	return self.medidor_tipo.nombre+'-'+self.nombre

# contrato/models.py {modelo Contrato}

aviso 				= models.IntegerField()
metros_local		= models.FloatField(null=True, blank=True)
metros_otros		= models.FloatField(null=True, blank=True)
arriendo_local		= models.FloatField(null=True, blank=True)
arriendo_otros		= models.FloatField(null=True, blank=True)
arriendo_porcentual	= models.FloatField(null=True, blank=True)
reajuste_porcentaje	= models.FloatField(null=True, blank=True)
reajuste_meses		= models.FloatField(null=True, blank=True)
fondo_promocion		= models.FloatField(null=True, blank=True)
cuota_promocion 	= models.FloatField(null=True, blank=True)
arriendo_diciembre 	= models.CharField(max_length=250)
inicio_renta 		= models.CharField(max_length=250)
gasto_comun_local 	= models.FloatField(null=True, blank=True)
gasto_comun_otros 	= models.FloatField(null=True, blank=True)

# contrato/urls.py

url(r'^contrato/pdf/(?P<pk>\d+)$', views.contratoPdf, name='contrato_pdf'),

# contrato/views.py

from reportlab.pdfgen import canvas
from reportlab.lib.enums import TA_RIGHT, TA_CENTER, TA_JUSTIFY, TA_LEFT
from reportlab.lib.pagesizes import LEGAL, A4, cm
from reportlab.lib.pagesizes import landscape
from reportlab.pdfgen import canvas
from reportlab.platypus import *
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.lib import colors

def makeReportData(detalle):

	contrato_list = list()
	cabecera_list = list()
	for j in detalle['contrato']:
		detalle_contrato = list()
		detalle_contrato.append(j['nombre_contrato'])
		detalle_contrato.append(j['monto'])
		contrato_list.append(detalle_contrato)


		styles = getSampleStyleSheet()
		styleBH = styles["Title"]
		styleBH.alignment = TA_LEFT
		styleBH.fontSize = 8
		styleBH.leading = 15
		styleBH.underline = 1

		cabecera_list.append('Contrato')
		cabecera_list.append('Monto')

		for a in cabecera_list:
			Paragraph(a, styleBH)

			libroreporte = []


			lines_cabecera = tuple(cabecera_list)
			libroreporte += lines_cabecera,

			for a in contrato_list:
				lines = tuple(a)
				libroreporte += lines,


				return libroreporte

				def contratoPdf(request, pk):
					array_elementos = list()
					contrato_list 	= list()
					total 	= 0
					proceso = Proceso.objects.get(pk=pk)

					for detalle in proceso.proceso_detalle_set.all():

						contrato_list.append({
							'id':detalle.id,
							'nombre_contrato':detalle.contrato_id,
							'monto':detalle.total,
							})

						array_elementos.append({
							'id': 1,
							'concepto': 'arriendos',
							'contrato': contrato_list
							})


						response = HttpResponse(content_type='application/pdf')
						response['Content-Disposition'] = 'attachment; filename="somefilename.pdf"'
						
	# Create the PDF object, using the response object as its "file."
	c = canvas.Canvas(response)


	# c = canvas.Canvas(pagesize=landscape(A4))
	c.setLineWidth(.3)

	# contrato_list= list()
	# contrato_list.append({
	# 	'id' : 1,
	# 	'nombre_contrato': "contrato 1",
	# 	'monto' : 5000
	# })

	# contrato_list.append({
	# 	'id': 1,
	# 	'nombre_contrato': "contrato 2",
	# 	'monto': 10000
	# })

	# array_elementos = list()
	# array_elementos.append({
	# 	'id': 1,
	# 	'concepto': 'arriendos',
	# 	'contrato': contrato_list
	# })
wd, hg = A4
	##GENERACION DOCUMENTO
	for a in array_elementos:

		##GENERACION TABLA DEL DOCUMENTO
		hight = 600

		table = Table(makeReportData(a),
			colWidths=[2.1 * cm, 4.1 * cm, 3.1 * cm, 2.9 * cm, 2.9 * cm, 2.9 * cm, 2.9 * cm,
			2.9 * cm, 2.5 * cm, 2 * cm])

		table.setStyle(TableStyle([
			('FONTSIZE', (0, 1), (-1, -1), 8),
			]))

		table.setStyle(TableStyle([("LINEBELOW", (0, 0), (-1, 1), 0.25, colors.black)]))

		table.wrapOn(c, wd, hg)
		# table.drawOn(c, 30, hight - (a.__len__() * 36) - 30)
		table.drawOn(c, 30, hight)

		c.showPage()

		c.save()

		return response

		def arriendo(request, id=None):
	# if this is a POST request we need to process the form data
	if request.method == 'POST':
		# create a form instance and populate it with data from the request:
		form = NameForm(request.POST)
		# check whether it's valid:
		if form.is_valid():
			# process the data in form.cleaned_data as required
			# ...
			# redirect to a new URL:
			return HttpResponseRedirect('/thanks/')

	# if a GET (or any other method) we'll create a blank form
else:
	form = NameForm()

	return render(request, 'viewer/contratos/contrato_arriendo.html', {'form': form})

# viewer/templates/procesos/procesos_list.html

function send_data_contratos(){

var data 			= {}
var contratos 		= []
var tabla_contrato 	= $('#tabla-contratos').dataTable();

data.fecha_inicio 	= '01-01-2015' //{falta, agregar la fecha que correponda}
data.fecha_termino 	= '31-12-2015' //{falta, agregar la fecha que correponda}

$('.checkbox-contrato:checked', tabla_contrato.fnGetNodes()).each(function(i){

	contrato 			= {}
	contrato.id 		= $(this).val()
	contrato.conceptos 	= [1] //{falta, agregar la fecha que correponda}

	contratos.push(contrato)
	})

data.contratos = JSON.stringify(contratos)

console.log(data)

$.ajax({
	url: '/procesos/contratos/propuesta',
	type: 'POST',
	data: data,
	success: function (response) {
	console.log(response)
	},
	error: function(response){

	}
	})

// $.post('/procesos/contratos/propuesta',{
	// 	'data': data,
	// 	csrfmiddlewaretoken: getCookie('csrftoken')
	// },
	// function(response){
	// 	console.log(response)
	// })

}

# operaciones/urls.py

url(r'^lectura-medidores/new$', views.LecturaMedidorNew.as_view(), name='lectura_medidor_new'),
url(r'^lectura-medidores/delete/(?P<pk>\d+)$', views.LecturaMedidorDelete.as_view(), name='lectura_medidor_delete'),
url(r'^lectura-medidores/update/(?P<pk>\d+)$', views.LecturaMedidorUpdate.as_view(), name='lectura_medidor_update'),

# operaciones/forms.py

class LecturaMedidorForm(forms.ModelForm):

	fecha = forms.DateField(input_formats=['%d/%m/%Y'], widget=forms.TextInput(attrs={'class': 'form-control format-date'}), error_messages={'required': 'campo requerido.', 'invalid': 'campo invalido'})

	class Meta:

		model 	= Lectura_Medidor
		fields 	= '__all__'
		exclude = [ 'visible', 'creado_en', 'user', 'imagen_type', 'imagen_size']

		widgets = {
		'valor'			: forms.NumberInput(attrs={'class': 'form-control'}),
		'mes'			: forms.Select(attrs={'class': 'form-control'}),
		'imagen_file'	: forms.FileInput(attrs={'class': 'file-format'}),
		}

		error_messages = {
		'valor' 		: {'required': 'campo requerido.'},
		}

		labels = {
		'valor'			: 'Lectura',
		'imagen_file'	: 'Cargar Imagen',
		}

		help_texts = {
		'valor'			: '...',
		'imagen_file'	: '...',
		}

# operaciones/views.py

class LecturaMedidorMixin(object):

	template_name = 'viewer/operaciones/lectura_medidor_new.html'
	form_class = LecturaMedidorForm
	success_url = '/lectura-medidores/list'

	def form_invalid(self, form):
		response = super(LecturaMedidorMixin, self).form_invalid(form)
		if self.request.is_ajax():
			return JsonResponse(form.errors, status=400)
		else:
			return response

			def form_valid(self, form):
				user 	= User.objects.get(pk=self.request.user.pk)
				profile = UserProfile.objects.get(user=user)

				obj = form.save(commit=False)
				obj.user = user
		# obj.empresa_id = profile.empresa_id
		obj.save()

		response = super(LecturaMedidorMixin, self).form_valid(form)
		if self.request.is_ajax():
			data = {
			'pk': 'self.object.pk',
			}
			return JsonResponse(data)
		else:
			return response

			class LecturaMedidorNew(LecturaMedidorMixin, FormView):
				def get_context_data(self, **kwargs):
					
					context = super(LecturaMedidorNew, self).get_context_data(**kwargs)
					context['title'] = 'Operaciones'
					context['subtitle'] = 'Lectura Medidor'
					context['name'] = 'Nueva'
					context['href'] = 'lectura-medidores'
					context['accion'] = 'create'
					return context

					class LecturaMedidorDelete(DeleteView):
						model = Lectura_Medidor
						success_url = reverse_lazy('/contratos-tipo/list')

						def delete(self, request, *args, **kwargs):
							self.object = self.get_object()
							self.object.visible = False
							self.object.save()
							payload = {'delete': 'ok'}
							return JsonResponse(payload, safe=False)

							class LecturaMedidorUpdate(LecturaMedidorMixin, UpdateView):

								model 			= Lectura_Medidor
								form_class 		= LecturaMedidorForm
								template_name 	= 'viewer/operaciones/lectura_medidor_new.html'
								success_url 	= '/lectura-medidores/list'

								def get_object(self, queryset=None):

									queryset = Lectura_Medidor.objects.get(id=int(self.kwargs['pk']))

									if queryset.fecha:
										queryset.fecha = queryset.fecha.strftime('%d/%m/%Y')

										return queryset

										def get_context_data(self, **kwargs):
											
											context = super(LecturaMedidorUpdate, self).get_context_data(**kwargs)
											context['title'] 	= 'Operaciones'
											context['subtitle'] = 'Lectura Medidores'
											context['name'] 	= 'Editar'
											context['href'] 	= 'lectura-medidores'
											context['accion'] 	= 'update'
											return context


# viewer/tamplates/viewer/contratos/contrato_arriendo_new.html

{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">
				<div class="ibox-title">
					<h5>Nuevo Arriendo</h5>
				</div>
				<div class="ibox-content">
					<div class="row">
						<div class="col-sm-12">

							<form id="form-arriendo-new" role="form" action="" method="post">
								{% csrf_token %}

								{{ formset_detalle.management_form }}
								{% for form in formset_detalle %}
								{% for hidden in form.hidden_fields %}
								{{ hidden }}
								{% endfor %}
								{% endfor %}

								<table id="tabla-arriendo" class="table">
									<thead>
										{% for form in formset_detalle %}
										{% if forloop.first %}
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.mes_inicio.help_text }}" ></i>
											{{ form.mes_inicio.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.mes_termino.help_text }}" ></i>
											{{ form.mes_termino.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.valor.help_text }}" ></i>
											{{ form.valor.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.moneda.help_text }}" ></i>
											{{ form.moneda.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.metro_cuadrado.help_text }}" ></i>
											{{ form.metro_cuadrado.label_tag }}
										</th>

										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="eliminar" ></i>
											<label>ELiminar:</label>
										</th>
										{% endif %}
										{% endfor %}
									</thead>
									<tbody>
										{% for form in formset_detalle %}
										<tr>
											<td>

												<div class="form-group">
													{{ form.mes_inicio }}
													<div class="container-error">
														{{ form.mes_inicio.errors }}
													</div>
												</div>
											</td>
											<td>

												<div class="form-group">
													{{ form.mes_termino }}
													<div class="container-error">
														{{ form.mes_termino.errors }}
													</div>
												</div>
											</td>
											<td>

												<div class="form-group">

													{{ form.valor }}
													<div class="container-error">
														{{ form.valor.errors }}
													</div>
												</div>
											</td>
											<td>

												<div class="form-group">

													{{ form.moneda }}
													<div class="container-error">
														{{ form.moneda.errors }}
													</div>
												</div>
											</td>
											<td class="text-center">

												<div class="form-group">

													{{ form.metro_cuadrado }}
													<div class="container-error">
														{{ form.metro_cuadrado.errors }}
													</div>
												</div>
											</td>
											<td class="text-center">

												<div class="form-group">

													{{ form.DELETE }}
												</div>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>


								<div class="row">

									<input type="hidden" id="id_contrato" name="contrato" value="{{contrato_id}}">

									<div class="form-group col-sm-2">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.reajuste.help_text }}" ></i>
										{{ form.reajuste.label_tag }}
										{{ form.reajuste }}
										<div class="container-error">
											{{ form.reajuste.errors }}
										</div>
									</div>

									<div class="form-group col-sm-2">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.meses.help_text }}" ></i>
										{{ form.meses.label_tag }}
										{{ form.meses }}
										<div class="container-error">
											{{ form.meses.errors }}
										</div>
									</div>

									<div class="form-group col-sm-2">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.valor.help_text }}" ></i>
										{{ form.valor.label_tag }}
										{{ form.valor }}
										<div class="container-error">
											{{ form.valor.errors }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.moneda.help_text }}" ></i>
										{{ form.moneda.label_tag }}
										{{ form.moneda }}
										<div class="container-error">
											{{ form.moneda.errors }}
										</div>
									</div>

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.fecha_inicio.help_text }}" ></i>
										{{ form.fecha_inicio.label_tag }}
										<div class="input-group date">
											{{ form.fecha_inicio }}
											<span class="input-group-addon">
												<i class="fa fa-calendar"></i>
											</span>
										</div>

										<div class="container-error">
											{{ form.fecha_inicio.errors }}
										</div>
									</div>

								</div>

								<br>
								<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">GUARDAR Y SALIR</button>
								<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button" style="margin-right: 15px;" onclick="enviar_form('{{accion}}')">GUARDAR Y SEGUIR</button>
								<a href="/contratos-tipo/list">
									<button class="btn btn-w-m btn-sm btn-success pull-right" type="button" style="margin-right: 15px;">CANCELAR</button>
								</a>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

$(document).ready(function(){
	var configuracion = {
		'order': false,
		'paginate': false,
		'bLengthChange': false,
		'bInfo': false,
		'buttons': [],
	} 


	var columns = [
	{
		'width': '15%',
		'orderable': false,
		'data': 'mes_inicio',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'mes_termino',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'valor',
	},
	{
		'width': '20%',
		'orderable': false,
		'data': 'moneda',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'metros',
	},
	{
		'width': '10%',
		'orderable': false,
		'data': 'eliminar',
	}];

	var table = load_table('#tabla-arriendo', columns, configuracion)

});

function enviar_form(accion){
	$.ajax({
		type: 'post',
		url: $('#form-arriendo-new').attr('action'),
		data: $('#form-arriendo-new').serialize(),
		success: function(response) {

			if (accion == 'create') {
				clear_form('#form-arriendo-new')
			}
			clear_errors_form('#form-arriendo-new')

			notification_toast('success', 'ÉXITO', 'Guardado correctamente.')
		},
		error: function(data, textStatus, jqXHR) {

			clear_errors_form('#form-arriendo-new')

			var errors = $.parseJSON(data.responseText)
			apply_errors_form(errors)
		}
	});
	return false;
	
}

</script>
{% endblock scripts %}

# activos/forms.py

class ActivoMedidoForm(forms.ModelForm):

	class Meta:
		model 	= Activo
		fields 	= ['id']

class LocalForm(forms.ModelForm):

	def __init__(self, *args, **kwargs):

		self.request 	= kwargs.pop('request')
		activo_id 		= kwargs.pop('activo_id', None)
		local_id 		= kwargs.pop('local_id', None)
		user 			= User.objects.get(pk=self.request.user.pk)
		profile 		= UserProfile.objects.get(user=user)

		super(LocalForm, self).__init__(*args, **kwargs)

		activo = Activo.objects.get(id=activo_id)

		if local_id is not None:
			locales = activo.local_set.all().values_list('id', flat=True).exclude(id__in=local_id)
		else:
			locales = activo.local_set.all().values_list('id', flat=True)

		medidores_locales_electricidad 					= Medidor_Electricidad.objects.filter(local__in=locales)
		medidores_locales_agua 							= Medidor_Agua.objects.filter(local__in=locales)
		medidores_locales_gas 							= Medidor_Gas.objects.filter(local__in=locales)

		self.fields['medidores_electricidad'].queryset 	= Medidor_Electricidad.objects.filter(activo_id=activo).exclude(id__in=medidores_locales_electricidad)
		self.fields['medidores_agua'].queryset 			= Medidor_Agua.objects.filter(activo_id=activo).exclude(id__in=medidores_locales_agua)
		self.fields['medidores_gas'].queryset 			= Medidor_Gas.objects.filter(activo_id=activo).exclude(id__in=medidores_locales_gas)

		self.fields['local_tipo'].queryset 				= Local_Tipo.objects.filter(empresa=profile.empresa)
		self.fields['sector'].queryset 					= Sector.objects.filter(activo=activo)
		self.fields['nivel'].queryset 					= Nivel.objects.filter(activo=activo)
		self.fields['medidores_electricidad'].required 	= False
		self.fields['medidores_agua'].required 			= False
		self.fields['medidores_gas'].required 			= False

# activos/views.py

class ActivoLocaleMixin(object):

	template_name = 'viewer/activos/activo_local_new.html'
	form_class = LocalForm
	success_url = '/locales/list'

	def get_form_kwargs(self):

		kwargs = super(ActivoLocaleMixin, self).get_form_kwargs()

		kwargs['request'] 	= self.request
		kwargs['activo_id'] = self.kwargs['activo_id']

		try:
			kwargs['local_id'] = self.kwargs['pk']
		except KeyError:
			pass

		return kwargs

class ActivoMedidorMixin(object):

	template_name = 'viewer/activos/activo_medidor_new.html'
	form_class = ActivoMedidoForm
	success_url = '/activos/list'

	def form_invalid(self, form):

		response = super(ActivoMedidorMixin, self).form_invalid(form)
		if self.request.is_ajax():
			return JsonResponse(form.errors, status=400)
		else:
			return response

	def form_valid(self, form):

		context 			= self.get_context_data()
		form_electricidad 	= context['form_electricidad']
		form_gas 			= context['form_gas']
		form_agua 			= context['form_agua']

		if form_electricidad.is_valid():
			form_electricidad.save()

		if form_agua.is_valid():
			form_agua.save()

		if form_gas.is_valid():
			form_gas.save()

		response = super(ActivoMedidorMixin, self).form_valid(form)
		if self.request.is_ajax():
			data = {
				'status': 'ok',
			}
			return JsonResponse(data)
		else:
			return response

class ActivoMedidorNew(ActivoMedidorMixin, FormView):

	def get_context_data(self, **kwargs):

		context 				= super(ActivoMedidorNew, self).get_context_data(**kwargs)
		context['title'] 		= 'Activos'
		context['subtitle'] 	= 'Medidor'
		context['name'] 		= 'Nuevo'
		context['href'] 		= 'activos'
		context['accion'] 		= 'update'
		context['activo_id']	= self.kwargs['activo_id']

		if self.request.POST:

			activo 	= Activo.objects.get(id=self.kwargs['activo_id'])

			try:
				medidor_electricidad = Medidor_Electricidad.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_electricidad'] = ElectricidadFormSet(self.request.POST, instance=activo)
			except Medidor_Electricidad.DoesNotExist:
				context['form_electricidad'] = ElectricidadFormSet(self.request.POST)

			try:
				medidor_agua = Medidor_Agua.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_agua'] = AguaFormSet(self.request.POST, instance=activo)
			except Medidor_Agua.DoesNotExist:
				context['form_agua'] = AguaFormSet(self.request.POST)

			try:
				medidor_gas = Medidor_Gas.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_gas'] = GasFormSet(self.request.POST, instance=activo)
			except Medidor_Gas.DoesNotExist:
				context['form_gas'] = GasFormSet(self.request.POST)

		else:

			activo 	= Activo.objects.get(id=self.kwargs['activo_id'])

			try:
				medidor_electricidad = Medidor_Electricidad.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_electricidad'] = ElectricidadFormSet(instance=activo)
			except Medidor_Electricidad.DoesNotExist:
				context['form_electricidad'] = ElectricidadFormSet()

			try:
				medidor_agua = Medidor_Agua.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_agua'] = AguaFormSet(instance=activo)
			except Medidor_Agua.DoesNotExist:
				context['form_agua'] = AguaFormSet()

			try:
				medidor_gas = Medidor_Gas.objects.filter(activo_id=self.kwargs['activo_id'])
				context['form_gas'] = GasFormSet(instance=activo)
			except Medidor_Gas.DoesNotExist:
				context['form_gas'] = GasFormSet()

		return context

# viewer/templates/viewer/activos/activo_medidor_new.html

{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">
				<form id="form-medidor-new" role="form" action="" method="post">

					{% csrf_token %}

					<div class="ibox-title">
						<h5>Medidores de Electricidad</h5>
					</div>

					<div class="ibox-content">
						<br>
						<div class="row">
							<div class="col-sm-12">

								{{ form_electricidad.management_form }}
								{% for form in form_electricidad %}
								{% for hidden in form.hidden_fields %}
								{{ hidden }}
								{% endfor %}
								{% endfor %}

								<button type="button" class="btn btn-primary btn-xs pull-right" onclick="agregar_fila('tabla-electricidad', 'medidor_electricidad')"><i class="fa fa-plus"></i> Medidor de Electricidad</button>
								<table id="tabla-electricidad" class="table">
									<thead>
										{% for form in form_electricidad %}
										{% if forloop.first %}
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.nombre.help_text }}" ></i>
											{{ form.nombre.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.numero_rotulo.help_text }}" ></i>
											{{ form.numero_rotulo.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia.help_text }}" ></i>
											{{ form.potencia.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_presente.help_text }}" ></i>
											{{ form.potencia_presente.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_fuera.help_text }}" ></i>
											{{ form.potencia_fuera.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.tarifa_electricidad.help_text }}" ></i>
											{{ form.tarifa_electricidad.label_tag }}
										</th>
										<th></th>
										{% endif %}
										{% endfor %}
									</thead>
									<tbody>
										{% for form in form_electricidad %}
										<tr>
											<td>
												<div class="form-group">
													{{ form.nombre }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.numero_rotulo }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_presente }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_fuera }}
												</div>
											</td>
											<td class="text-center">
												<div class="form-group">
													{{ form.tarifa_electricidad }}
												</div>
											</td>
											<td class="text-center delete">
												<div class="form-group text-center">
													{{ form.DELETE }}
													<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete_child(this, 'Medidor')"><i class="fa fa-trash"></i></a>
												</div>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>


					<div class="ibox-title">
						<h5>Medidores de Agua</h5>
					</div>

					<div class="ibox-content">
						<br>
						<div class="row">
							<div class="col-sm-12">

								{{ form_agua.management_form }}
								{% for form in form_agua %}
								{% for hidden in form.hidden_fields %}
								{{ hidden }}
								{% endfor %}
								{% endfor %}

								<button type="button" class="btn btn-primary btn-xs pull-right" onclick="agregar_fila('tabla-agua', 'medidor_agua')"><i class="fa fa-plus"></i> Medidor de Agua</button>
								<table id="tabla-agua" class="table">
									<thead>
										{% for form in form_agua %}
										{% if forloop.first %}
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.nombre.help_text }}" ></i>
											{{ form.nombre.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.numero_rotulo.help_text }}" ></i>
											{{ form.numero_rotulo.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia.help_text }}" ></i>
											{{ form.potencia.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_presente.help_text }}" ></i>
											{{ form.potencia_presente.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_fuera.help_text }}" ></i>
											{{ form.potencia_fuera.label_tag }}
										</th>
										<th></th>
										{% endif %}
										{% endfor %}
									</thead>
									<tbody>
										{% for form in form_agua %}
										<tr>
											<td>
												<div class="form-group">
													{{ form.nombre }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.numero_rotulo }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_presente }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_fuera }}
												</div>
											</td>
											<td class="text-center delete">
												<div class="form-group text-center">
													{{ form.DELETE }}
													<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete_child(this, 'Medidor')"><i class="fa fa-trash"></i></a>
												</div>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>

					<div class="ibox-title">
						<h5>Medidores de Gas</h5>
					</div>

					<div class="ibox-content">
						<br>
						<div class="row">
							<div class="col-sm-12">

								{{ form_gas.management_form }}
								{% for form in form_gas %}
								{% for hidden in form.hidden_fields %}
								{{ hidden }}
								{% endfor %}
								{% endfor %}

								<button type="button" class="btn btn-primary btn-xs pull-right" onclick="agregar_fila('tabla-gas', 'medidor_')"><i class="fa fa-plus"></i> Medidor de Gas</button>
								<table id="tabla-gas" class="table">
									<thead>
										{% for form in form_gas %}
										{% if forloop.first %}
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.nombre.help_text }}" ></i>
											{{ form.nombre.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.numero_rotulo.help_text }}" ></i>
											{{ form.numero_rotulo.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia.help_text }}" ></i>
											{{ form.potencia.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_presente.help_text }}" ></i>
											{{ form.potencia_presente.label_tag }}
										</th>
										<th>
											<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.potencia_fuera.help_text }}" ></i>
											{{ form.potencia_fuera.label_tag }}
										</th>
										<th></th>
										{% endif %}
										{% endfor %}
									</thead>
									<tbody>
										{% for form in form_gas %}
										<tr>
											<td>
												<div class="form-group">
													{{ form.nombre }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.numero_rotulo }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_presente }}
												</div>
											</td>
											<td>
												<div class="form-group">
													{{ form.potencia_fuera }}
												</div>
											</td>
											<td class="text-center delete">
												<div class="form-group text-center">
													{{ form.DELETE }}
													<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete_child(this, 'Medidor')"><i class="fa fa-trash"></i></a>
												</div>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
						<br>
						<br>
						<a href="/activos/list"><button class="btn btn-w-m btn-sm btn-default" type="button">CANCELAR</button></a>
						<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">GUARDAR Y SALIR</button>
						<button class="btn btn-w-m btn-sm btn-primary pull-right" type="button" style="margin-right: 15px;" onclick="guardar_formulario('{{accion}}', 'form-medidor-new')">GUARDAR Y SEGUIR</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

var tabla_electricidad 	= []
var tabla_agua			= []
var tabla_gas			= []

$(document).ready(function(){

	var configuracion = {
		'order': false,
		'paginate': false,
		'bLengthChange': false,
		'bInfo': false,
		'searching':false,
		'buttons': [],
	}

	load_table_electricidad(configuracion)
	load_table_agua(configuracion)
	load_table_gas(configuracion)

});


function load_table_electricidad(configuracion){

	var columns = [
	{
		'width': '15%',
		'orderable': false,
		'data': 'nombre',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'numero_rotulo',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia',
	},
	{
		'width': '20%',
		'orderable': false,
		'data': 'potencia_presente',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia_fuera',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'tarifa',
	},
	{
		'width': '10%',
		'orderable': false,
		'data': 'eliminar',
	}];

	tabla_electricidad = load_table('#tabla-electricidad', columns, configuracion)
}

function load_table_agua(configuracion){

	var columns = [
	{
		'width': '15%',
		'orderable': false,
		'data': 'nombre',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'numero_rotulo',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia',
	},
	{
		'width': '20%',
		'orderable': false,
		'data': 'potencia_presente',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia_fuera',
	},
	{
		'width': '10%',
		'orderable': false,
		'data': 'eliminar',
	}];

	tabla_agua = load_table('#tabla-agua', columns, configuracion)
}

function load_table_gas(configuracion){

	var columns = [
	{
		'width': '15%',
		'orderable': false,
		'data': 'nombre',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'numero_rotulo',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia',
	},
	{
		'width': '20%',
		'orderable': false,
		'data': 'potencia_presente',
	},
	{
		'width': '15%',
		'orderable': false,
		'data': 'potencia_fuera',
	},
	{
		'width': '10%',
		'orderable': false,
		'data': 'eliminar',
	}];

	tabla_gas = load_table('#tabla-gas', columns, configuracion)
}


</script>
{% endblock scripts %}

# contratos/urls.py

	url(r'^contratos/arriendo/$', views.ContratoArriendo.as_view(), name='contrato_arriendo'),
	url(r'^contratos/(?P<contrato_id>\d+)/arriendo/new$', views.ArriendoNew.as_view(), name='arriendo_new'),
	url(r'^contratos/(?P<contrato_id>\d+)/arriendo/update/(?P<arriendo_id>\d+)$', views.ArriendoUpdate.as_view(), name='arriendo_update'),
	url(r'^contratos/(?P<contrato_id>\d+)/informacion$', views.ArriendoPruebaNew.as_view(), name='arriendo_prueba_new'),

# viewer/templates/viewer/locales/local_list.html

select.push({'id':data[i].id, 'text':data[i].nombre})
select_config 	= {
	select 		: 's-activo',
	placeholder : 'Seleccionar Activo',
	data: select
}
format_select(select_config)
$('#url-new-local').attr('href', '/activos/'+$('#s-activo').val()+'/locales/new')

# contrato/forms.py

class ServicioBasicoForm(forms.ModelForm):

	def __init__(self, *args, **kwargs):

		contrato = kwargs.pop('contrato', None)
		super(ServicioBasicoForm, self).__init__(*args, **kwargs)

		if contrato is not None:
			self.fields['local'].queryset = contrato.locales.all()

	class Meta:
		model 	= Servicio_Basico
		fields 	= '__all__'
		exclude = ['visible', 'creado_en']

		widgets = {
			'tipo'			: forms.Select(attrs={'class': 'form-control tipo-asd'}),
			'local'			: forms.Select(attrs={'class': 'form-control'}),
			'mes_inicio'	: forms.Select(attrs={'class': 'form-control'}),
			'mes_termino'	: forms.Select(attrs={'class': 'form-control'}),
			'valor'			: forms.NumberInput(attrs={'class': 'form-control'}),
		}

		error_messages = {
			'tipo'			: {'required': 'campo requerido.'},
			'mes_inicio'	: {'required': 'campo requerido.'},
			'mes_termino'	: {'required': 'campo requerido.'},
			'valor'			: {'required': 'campo requerido.'},
		}

		labels = {
			'tipo'			: 'Tipo',
			'mes_inicio'	: 'Meses Inicio',
			'mes_termino'	: 'Mes Termino',
		}

		help_texts = {
			'tipo' 			: 'tipo',
			'mes_inicio' 	: 'mes inicio',
			'mes_termino' 	: 'mes termino',
			'valor' 		: 'valor',
		}

ServicioBasicoFormSet 	= inlineformset_factory(Contrato, Servicio_Basico, form=ServicioBasicoForm, extra=1, can_delete=True)

# procesos/views.py

def calculo_arriendo_minimo(request, fecha_inicio, fecha_termino, contratos):

	user 		= User.objects.get(pk=request.user.pk)
	contratos 	= contratos
	f_inicio 	= primer_dia(datetime.strptime(fecha_inicio, "%d/%m/%Y"))
	f_termino 	= ultimo_dia(datetime.strptime(fecha_termino, "%d/%m/%Y"))
	fecha 		= ultimo_dia(datetime.strptime(fecha_inicio, "%d/%m/%Y"))
	meses		= meses_entre_fechas(f_inicio, f_termino)
	data 		= []

	proceso = Proceso(
		fecha_inicio		= f_inicio.strftime('%Y-%m-%d'),
		fecha_termino		= f_termino.strftime('%Y-%m-%d'),
		user				= user,
		concepto_id			= 1,
		proceso_estado_id 	= 1,
		)
	proceso.save()
	
	for x in range(meses):

		for item in contratos:

			total 		= 0
			contrato 	= Contrato.objects.get(id=item)

			try:
				arriendo = Arriendo.objects.get(contrato=contrato)
				detalles = Arriendo_Detalle.objects.filter(arriendo=arriendo)

				for detalle in detalles:
					if fecha.month >= int(detalle.mes_inicio) and fecha.month <= int(detalle.mes_termino):
						valor 	= detalle.valor
						moneda 	= detalle.moneda.id
						factor  = detalle.moneda.moneda_historial_set.all().order_by('-id').first().valor

						reajuste_valor 	= 1
						reajuste_moneda = 1
						reajuste_factor = 1
						reajuste 		= arriendo.reajuste
						metros 			= detalle.metro_cuadrado
						metros_valor 	= 1

						if arriendo.reajuste == True and fecha >= sumar_meses(arriendo.fecha_inicio, arriendo.meses):

							reajuste_valor 	= arriendo.valor
							reajuste_moneda = arriendo.moneda.id
							reajuste_factor = arriendo.moneda.moneda_historial_set.all().order_by('-id').first().valor

							if arriendo.moneda.id == 6:
								reajuste_valor = (reajuste_valor/100)+1
						
						if detalle.metro_cuadrado == True:
							locales =  contrato.locales.all()
							metros_valor = 0
							for local in locales:
								metros_valor += local.metros_cuadrados

					total = valor * factor * metros_valor * (reajuste_valor * reajuste_factor)

			except Arriendo.DoesNotExist:
				total = 0

			proceso_detalle = Proceso_Detalle(
				total 			= total,
				fecha_inicio	= primer_dia(fecha).strftime('%Y-%m-%d'),
				fecha_termino	= ultimo_dia(fecha).strftime('%Y-%m-%d'),
				proceso 		= proceso,
				contrato 		= contrato,
			)
			proceso_detalle.save()
			
			data.append({
				'id'				: proceso.id,
				'fecha_inicio'		: primer_dia(fecha),
				'fecha_termino'		: ultimo_dia(fecha),
				'concepto'			: 'Arriendo Minimo',
				'contrato_numero'	: contrato.numero,
				'contrato_nombre'	: contrato.nombre_local,
				'valor'				: total,
			})

		fecha = sumar_meses(fecha, 1)

	return data

