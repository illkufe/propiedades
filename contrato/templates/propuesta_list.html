{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">
				<div class="ibox-title">
					<h5>Lista de Propuestas</h5>
					<div class="ibox-tools">
						<a href='{% url "propuesta_new" %}'><button type="button" class="btn btn-primary btn-xs"><i class="fa fa-plus"></i> nueva propuesta</button></a>
					</div>
				</div>
				<div class="ibox-content">
					<div class="table-responsive">
						<table id="tabla-propuestas" class="table table-striped table-bordered table-hover" style="width:100%">
							<thead></thead>
							<tbody>
								{% for item in object_list %}
								<tr>
									<td>{{ item.id }}</td>
									<td>{{ item.numero }}</td>
									<td>{{ item.cliente.nombre }}</td>
									<td>{{ item.nombre_local }}</td>
									<td class="text-center"><span class="label">{{ item.tipo }}</span></td>
									<td class="text-right">{{ item.fecha_inicio }}</td>
									<td class="text-right">{{ item.fecha_termino }}</td>
									<td class="text-center">
										<a class="btn btn-edit btn-bitbucket" href='{% url "propuesta_update" item.id %}'><i class="fa fa-edit"></i></a>
										<a class="btn btn-delete btn-bitbucket" onclick="open_modal_delete(this, {{item.propuesta.id}}, 'propuesta', 'tabla-propuestas', 'Propusta')"><i class="fa fa-trash"></i></a>
										<a class="btn btn-download btn-bitbucket" href='{% url "propuesta_generar_pdf" item.id %}'><i class="fa fa-download"></i></a>
										<a class="btn btn-config btn-bitbucket" onclick="propuesta_ver_versiones({{item.propuesta.id}})"><i class="fa fa-history"></i></a>
										<a class="btn btn-send btn-bitbucket" data-toggle="modal" data-target="#m-propuesta-enviar-correo"><i class="fa fa-paper-plane"></i></a>
										<a class="btn btn-view btn-bitbucket" href='{% url "propuesta_historial" item.propuesta.id %}'><i class="fa fa-clock-o"></i></a>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<!-- Modal -->
<div class="modal fade" id="m-propuesta-enviar-correo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">Enviar Propuesta</h4>
			</div>
			<form id="propuesta-enviar-correo" action='{% url "propuesta_enviar_correo" %}' method="POST">

				{% csrf_token %}

				<input type="hidden" name="contenido">
				<input type="hidden" name="propuesta_id" value="1">

				<div class="modal-body">
					<div class="row">
						<div class="form-group">
							<div class="col-sm-3">
								<strong>Cliente</strong>
							</div>
							<div class="col-sm-9">: Cliente 02</div>
						</div>
						<div class="form-group">
							<div class="col-sm-3">
								<strong>Rut Cliente</strong>
							</div>
							<div class="col-sm-9">: 8.331.209-2</div>
						</div>
						<div class="form-group">
							<div class="col-sm-3">
								<strong>Marca Comercial</strong>
							</div>
							<div class="col-sm-9">: Ripley</div>
						</div>

						<div class="form-group">
							<div class="col-sm-3">
								<strong>Correo:</strong>
							</div>
							<div class="col-sm-9">: correo@empresa.cl</div>
						</div>

						<div class="form-group">
							<div class="col-sm-3">
								<strong>Telefono:</strong>
							</div>
							<div class="col-sm-9">: 87738991</div>
						</div>

						<!-- <div class="form-group">
							<div class="col-xs-12">
								<ul class="list-unstyled project-files"><li><a href="" style="margin-left:0px; margin-top:10px; display:inline-block;"><i class="fa fa-file"></i> Factura Propuesta.pdf</a></li></ul>
							</div>
						</div> -->
					</div>

					<br>

					<div class="row">
						<div class="col-xs-12">
							<div class="summernote"></div>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-w-m btn-sm btn-default" data-dismiss="modal">CERRAR</button>
					<button type="submit" class="btn btn-w-m btn-sm btn-primary">ENVIAR</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="m-versiones-propuesta" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">Versiones</h4>
			</div>
			<div class="modal-body">

				<div class="text-center">
					<p style="color:#ff8100; font-size:100px">
						<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
					</p>
					<p>Error</p>
				</div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">CERRAR</button>
			</div>
		</div>
	</div>
</div>

{% endblock section %}

{% block scripts %}
<script>

var tabla_propuestas;

$(document).ready(function(){

	initialize()
	load_tabla_propuestas()
	propuesta_enviar_correo()

});

function initialize(){

	$('.summernote').summernote();
}

function load_tabla_propuestas(){

	var columns = [
	{
		'data': 'id',
		'visible': false,
	},
	{
		'width': '5%',
		'data': 'numero',
		'title': 'NÂº',
	},
	{
		'width': '15%',
		'data': 'cliente',
		'title': 'Cliente',
	},
	{
		'width': '20%',
		'data': 'nombre',
		'title': 'Marca Comercial',
	},
	{
		'width': '15%',
		'data': 'tipo',
		'title': 'Tipo',
	},
	{
		'width': '10%',
		'data': 'fecha_inicio',
		'title': 'F.inicio',
	},
	{
		'width': '10%',
		'data': 'fecha_termino',
		'title': 'F.termino',
	},
	{
		'width': '25%',
		'data': 'options',
		'orderable': false,
		'title': '<div class="text-center">Opciones</div>',
	}];

	tabla_propuestas = load_table('#tabla-propuestas', columns, {})
}

function propuesta_enviar_correo(){

	$("#propuesta-enviar-correo").validate({

		submitHandler: function(form) {
			$("#propuesta-enviar-correo input[name='contenido']").val($('.summernote').code())
			// enviar formulario
			$('#propuesta-enviar-correo').ajaxSubmit({
				dataType: 'json',
				beforeSend: function(){
					// cerrar modal
					$('#m-propuesta-enviar-correo').modal('hide')
					// cargar loading
					loading(true)
				},
				success: function(response){
					// cerrar loading
					loading(false)
					// verificar respuesta
					if (response.estado == true) {
						var configuracion = {
							'toast_type'	: 'success',
							'toast_text' 	: 'correo(s) enviado(s)',
							'toast_title' 	: 'Correcto',
						}
					}else{
						var configuracion = {
							'toast_type'	: 'error',
							'toast_text' 	: response.mensaje,
							'toast_title' 	: 'Error',
						}
					}
					// mostrar respuesta
					notification_toast(configuracion)
				},
				error: function(){
					// cerrar loading
					loading(false)
				}
			});
		}
	})
}

function propuesta_ver_versiones(id){

	$.ajax({
		url: '/get/propuestas-contrato/'+id,
		type: 'get',
		dataType: 'json',
		success: function(data){
			console.log(data)
			$('#m-versiones-propuesta .modal-body').append(template_modal_propuesta_versiones(data[0]))
			$('#m-versiones-propuesta').modal('show')
		}
	})
}

function template_modal_propuesta_versiones(propuesta){

	// $('#m-versiones-propuesta .modal-body').html('')

	var template = ''

	template += '<table class="table table-striped" style="width:100%">'
	template += '<thead>'
	template += '<tr>'
	template += '<th>Fecha</th>'
	template += '<th class="text-center">Descargar</th>'
	template += '<th class="text-center">Restaurar</th>'
	template += '</tr>'
	template += '</thead>'
	template += '<tbody>'

	for (var i = 0; i < propuesta.versiones.length; i++) {

		template += '<tr>'
		template += '<td>@fecha</td>'
		template += '<td class="text-center"><a class="btn btn-view btn-bitbucket"><i class="fa fa-download"></i>@descargar</a></td>'
		template += '<td class="text-center"><a class="btn btn-view btn-bitbucket" onclick="propuesta_restaurar_version(@id)"><i class="fa fa-check-circle-o"></i>@restaurar</a></td>'
		template += '</tr>'

		template = template.replace(/@id/g, 		propuesta.versiones[i].id);
		template = template.replace(/@fecha/g, 		propuesta.versiones[i].creado_en);
		template = template.replace(/@descargar/g, 	propuesta.versiones[i].id);

		if (i==0) {
			template = template.replace(/@restaurar/g, 	'version actual');
		}else{
			template = template.replace(/@restaurar/g, 	propuesta.versiones[i].id);
		}
	};

	template += '</tbody>'
	template += '</table>'

	return template
}

function propuesta_restaurar_version(id){

	$.ajax({
		url: '/funcion/propuesta/restaurar_version/'+id,
		type: 'get',
		dataType: 'json',
		success: function(data){
			console.log(data)
			$('#m-versiones-propuesta .modal-body').append(template_modal_propuesta_versiones(data[0]))
			$('#m-versiones-propuesta').modal('show')
			
		}
	})
}



</script>
{% endblock scripts %}
