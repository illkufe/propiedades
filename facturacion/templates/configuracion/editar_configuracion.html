{% extends 'index.html' %}
{% block section %}
    {% include 'partials/breadcrumbs-bar.html' %}
    <div class="row wrapper wrapper-content animated fadeInRight" xmlns="http://www.w3.org/1999/html">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Parametros de Configuración</h5>
                </div>
                <div class="ibox-content">
                    <form method="post" action="" enctype="multipart/form-data" role="form" id="form_parametro_facturacion">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="hr-line-dashed"></div>
                                <label>Firmador/ Envia DTE</label>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-4 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="" ></i>
                                {{ parametros.persona.label_tag }}
                                {{ parametros.persona }}
                                <div class="input-group">
                                    <input id="id_codigo_persona" class="form-control input-sm" type="text" onkeydown="busca_persona(this, event, '#form_parametro_facturacion')" name="codigo_persona" maxlength="100">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="llena_modal_persona()"><i class="fa fa-plus"></i></button>
                                    </span>
                                </div>
                                <div class="container-error">
                                    {{ parametros.persona.errors|striptags}}
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <label for="id_descripcion">Nombre:</label>
                                <input id="id_descripcion_persona" class="form-control input-sm" type="text" name="nombre_persona" maxlength="100" disabled="disabled">
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="hr-line-dashed"></div>
                                <label>Conectividad</label>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-6 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{ parametros.codigo_conexion.id_for_label }}">
                                     {{ parametros.codigo_conexion.label_tag }}
                                </label>
                                {{ parametros.codigo_conexion}}
                                <div class="container-error">
                                    {{ parametros.codigo_conexion.errors }}
                                </div>
                            </div>
                            <div class="col-sm-6 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{ parametros.motor_emision.id_for_label }}">
                                     {{ parametros.motor_emision.label_tag }}
                                </label>
                                {{ parametros.motor_emision}}
                                <div class="container-error">
                                    {{ parametros.motor_emision.errors }}
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-4 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{ conexion.codigo_contexto.id_for_label }}">
                                     {{ conexion.codigo_contexto.label_tag }}
                                </label>
                                {{ conexion.codigo_contexto}}
                                <div class="container-error">
                                    {{ conexion.codigo_contexto.errors }}
                                </div>
                            </div>
                            <div class="col-sm-3 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{conexion.host.id_for_label }}">
                                     {{ conexion.host.label_tag }}
                                </label>
                                {{ conexion.host}}
                                <div class="container-error">
                                    {{ conexion.host.errors }}
                                </div>
                            </div>
                            <div class="col-sm-3 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{ conexion.url.id_for_label }}">
                                     {{ conexion.url.label_tag }}
                                </label>
                                {{ conexion.url}}
                                <div class="container-error">
                                    {{ conexion.url.errors }}
                                </div>
                            </div>
                            <div class="col-sm-2 form-group">
                                <i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="right" title="" ></i>
                                <label for="{{ conexion.puerto.id_for_label }}">
                                     {{ conexion.puerto.label_tag }}
                                </label>
                                {{ conexion.puerto}}
                                <div class="container-error">
                                    {{ conexion.puerto.errors }}
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="ibox-tools">
                            <a id="crear_conexion"  class="btn btn-primary btn-xs "><i class="fa fa-plus"></i> Crear configuración</a>
                            <div class="hr-line-dashed"></div>
                        </div>
                        <br>
                        <div class="table-responsive">
                            <div id="datos"></div>
                            <table id="tablaConexion" class="table table-striped table-hover" style="width: 100%!important">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-4">
                                <a href="{% url 'facturacion:visualizar_configuracion' %}" class="btn btn-cancel" role="button">
                                    Cancelar
                                </a>
                            </div>
                            <div class=" text-right col-md-4 col-md-offset-4">
                                <button type="button" onclick="enviar_form('form_parametro_facturacion')" class="btn btn-w-m btn-sm btn-primary pull-right">
                                    GUARDAR
                                </button>
{#                                <button type="button" class="btn btn-w-m btn-sm btn-primary pull-right" style="margin-right: 15px;" onclick="enviar_form('{{accion}}')">#}
{#                                    GUARDAR Y SEGUIR#}
{#                                </button>#}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal inmodal fade" id="modalPersona" tabindex="-1" role="dialog"  aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Personas</h4>
                    <small class="font-bold"></small>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock section %}
{% block Javascript %}
    <script>
    $(document).ready(function(){
        if($('#readonly_codigo').val()=='True'){
           $('#id_codigo').attr('readonly',true);
        }

        $('#id_codigo_persona').mask("##.###.###-A", {reverse: true, maxlength: 9});
        lista_conexion = new Array();

        var id_persona = parseInt($('#id_persona').val());
        if (id_persona != 0 || id_persona != 'NaN'){
            recupera_informacion_Persona(id_persona);
        }

        var configuracion = {
            'searching'     : true,
            'order'         : [[1, 'asc']],
            'paginate'      : false,
            'bLengthChange' : false,
            'bInfo'         : false,
            'buttons'       : []
        };

        var columns = [
            {
                'width' : '25%',
                'data'  : 'codigo_contexto',
                'title' : 'Código Contexto'
            },
            {
                'width'  : '15%',
                'data'   : 'host',
                'title'  : 'Host'
            },
            {
                'width' : '15%',
                'data'  : 'url',
                'title' : 'URL'
            },
            {
                'width': '15%',
                'data' : 'puerto',
                'title': 'Puerto'
            },
            {
                'width'     : '10%',
                'data'      : 'options',
                'orderable' : false,
                'title'     : 'Opciones'
            }];

        tabla_conexion = generar_tabla('#tablaConexion', columns, configuracion);
        recuperaDataParametros();

        $('#crear_conexion').on('click', function () {

            var codigo  =   $('#id_codigo_contexto').val();
            var host    =   $('#id_host').val();
            var url     =   $('#id_url').val();
            var puerto  =   $('#id_puerto').val();

            agregar_conexion(codigo, host, url, puerto);

        })
    });

    function busca_persona(obj, event, form){
            $('#errores').empty();

            if (event.which == 9 || event.which == 13) {
                $.ajax({
                    url: '{% url 'comercial:valida_idfiscal_persona' %}',
                    type: 'POST',
                    data: {
                        id_fiscal: obj.value,
                        type:''
                    },
                    success: function (response) {
                        if (response.error.length != 0) {

                            clear_errors_form('#'+form);

                            for (var i in response.error){
                                error_ul = "<ul class='errorlist'><li>"+response.error[i]+"</li></ul>";
                                $("#id_persona").parent().find('.container-error').append(error_ul);
                            }

                            $('#'+form).find('#id_descripcion_persona').val("");
                            $('#'+form).find('#id_codigo_persona').focus();
                        }
                        else {
                            clear_errors_form('#'+form);

                            $('#'+form).find('#id_codigo_persona').val(response.id_fiscal);
                            $('#'+form).find('#id_descripcion_persona').val(response.razon);
                            $('#'+form).find('#id_persona').val(response.id);
                        }
                    },
                    error: function (x, a, t) {
                        swal({
                            title   : "Error!",
                            text    : "Error al validar el R.U.T. de la persona",
                            type    : "error",
                            confirmButtonText: "Ok"
                        });
                        console.log(x, a, t);
                    }
                });
            }
        }

    function llena_modal_persona(){
            $.ajax({
                type: 'POST',
                url: '{% url 'facturacion:busca_personas' %}',
                success: function (data, textStatus, jqXHR) {

                    var html = "";
                    var formu ="#filtro_persona";
                    var tabla ="#tablaModalPersona";
                    html+='<form id="filtro_persona" role="form" enctype="multipart/form-data" action="" method="post">';
                    html+='<div class="row">';
                    html+='<div class="col-sm-4">';
                    html+='<div class="">';
                    html+='<label for="id_codigo">R.U.T</label>';
                    html+='<input id="id_codigo" class="form-control col2_filter" type="text" placeholder="r.u.t." onkeyup="search_column_table_reference_products(this, \''+formu+'\', \''+tabla+'\')" name="id_fiscal" maxlength="100" data-column="2">';
                    html+='</div>';
                    html+='</div>';
                    html+='<div class="col-sm-4">';
                    html+='<div class="">';
                    html+='<label for="id_razon">Razón Social</label>';
                    html+='<input id="id_razon" class="form-control col3_filter" type="text" placeholder="razón" name="razon_social" data-column="3" onkeyup="search_column_table_reference_products(this, \''+formu+'\', \''+tabla+'\')">';
                    html+='</div></div>';
                    html+='<div class="col-sm-4">';
                    html+='<div class="">';
                    html+='<label for="id_nombre">Nombre Fantasia</label>';
                    html+='<input id="id_nombre" class="form-control col4_filter" type="text" placeholder="nombre" name="nombre_fantasia" data-column="4" onkeyup="search_column_table_reference_products(this, \''+formu+'\', \''+tabla+'\')">';
                    html+='</div></div>';
                    html+='</div>';
                    html+='</form>';

                    html+='<div class="table-responsive">';
                    html+='<table id="tablaModalPersona" class="table table-striped table-bordered" style="width: 100% !important;">';
                    html+='<thead>';
                    html+='</thead>';
                    html+='<tbody>';

                    for(var i in data.lista_cliente){
                        html+='<tr>';
                        html+='<td>'+data.lista_cliente[i].id+'</td>';
                        html+='<td class="text-center"><button type="button" class="btn btn-info btn-xs" onclick="seleccionarPersonas( \''+data.lista_cliente[i].id_fiscal+'\' , \''+data.lista_cliente[i].razon_social+'\', \''+data.lista_cliente[i].id+'\' )"><i class="fa fa-eye"></i> Seleccionar</button></a></td>';
                        html+='<td class="">'+data.lista_cliente[i].id_fiscal+'</td>';
                        html+='<td>'+data.lista_cliente[i].nombre_fantasia+'</td>';
                        html+='<td>'+data.lista_cliente[i].razon_social+'</td>';
                        html+='</tr>';
                    }
                    html+='</tbody>';
                    html+='</table>';
                    html+='</div>';

                    $('#modalPersona').find('.modal-body').html(html);

                    var configuracion = {
                      'searching'       : true,
                      'order'           : [[2, 'asc']],
                      'paginate'        : false,
                      'bLengthChange'   : false,
                      'bInfo'           : false,
                      'buttons'         : []
                    };

                    var columns = [
                        {
                            'width'     : '1%',
                            'data'      : 'id',
                            'title'     : 'Id',
                            'visible'   : false
                        },
                        {
                            'width'     : '15%',
                            'data'      : 'options',
                            'orderable' : false,
                            'title'     : 'Opciones'
                        },

                        {
                            'width' : '4%',
                            'data'  : 'id_fiscal',
                            'title' : 'R.U.T'
                        },
                        {
                            'width': '5%',
                            'data' : 'razon',
                            'title': 'Razón Social'
                        },
                        {
                            'width': '5%',
                            'data' : 'nombre',
                            'title': 'Nombre Fantasia'
                        }];

                    var tabla = generar_tabla('#tablaModalPersona', columns, configuracion);
                    $('#modalPersona').modal('show');
                },
                error:function (x, y, z) {
                    swal("Error!", "No se pudo recuperar los Persona", "error");
                    console.log(x, y, z);
                }
            });
        }

    function seleccionarPersonas(id_fiscal, razon, id) {
            $('#form_parametro_facturacion').find('#id_codigo_persona').val(id_fiscal);
            $('#form_parametro_facturacion').find('#id_descripcion_persona').val(razon);
            $('#form_parametro_facturacion').find('#id_persona').val(id);
            $('#modalPersona').modal('hide');
    }

    function recupera_informacion_Persona(id_persona) {
            var codigo = 0;
            $.ajax({
                url: '{% url 'comercial:valida_idfiscal_persona' %}',
                type: 'POST',
                data: {
                    id_cliente: id_persona,
                    codigo : codigo
                },
                success: function (response) {
                    if (response.error.length != 0) {
                        html = '';
                        html += '<ul>';
                        for (var i in response.error) {
                            html += '<li>' + response.error[i] + '</li><br>';
                        }
                        html += '</ul>';

                        $('#form_parametro_facturacion').find('#id_descripcion_persona').val("");
                        $('#errores').html(html);
                        $('#form_parametro_facturacion').find('#id_codigo_persona').focus();
                    }
                    else {
                        $('#errores').empty();

                        $('#form_parametro_facturacion').find('#id_codigo_persona').val(response.id_fiscal);
                        $('#form_parametro_facturacion').find('#id_descripcion_persona').val(response.razon);
                        $('#form_parametro_facturacion').find('#id_persona').val(response.id);
                    }
                },
                error: function (x, a, t) {
                    swal({
                        title: "Error!",
                        text: "Error al validar el R.U.T. de la persona",
                        type: "error",
                        confirmButtonText: "Ok"
                    });
                    console.log(x, a, t);
                }
            });
        }

    function agregar_conexion(codigo, host, url, puerto) {
        if(valida_detalle(codigo, host, url, puerto)){

            var row = {};

            row.codigo_contexto     =   codigo;
            row.host                =   host;
            row.url                 =   url;
            row.puerto              =   puerto;
            row.options             =   '<td class="text-center"><a class="btn btn-success btn-xs" onclick="editar_conexion(this)" title="Editar"><i class="fa fa-edit"></i></a>  <a class="btn btn-danger btn-xs" onclick="elimina_conexion(this,\''+codigo+'\')" title="Eliminar"><i class="fa fa-trash "></i></a></td>';


            var data = {
                codigo_contexto  :   codigo,
                host    :   host,
                url     :   url,
                puerto  :   puerto
            };

            var datos_array = [];
            datos_array.push(codigo, host, url, puerto);

            if ($('#tablaConexion').find('tr.editar').length>0){

                var row = $('#tablaConexion').find('tr.editar').attr('id');

                var data = {
                    'id_detalle'        :   lista_conexion[parseInt(row)].id_detalle,
                    'codigo_contexto'   :   codigo,
                    'host'              :   host,
                    'url'               :   url,
                    'puerto'            :   puerto,
                    'borrar'            :   false
                };
                lista_conexion[row]=data;

                var tabla_update = $('#tablaConexion').dataTable();
                for (i in datos_array){
                    tabla_update.fnUpdate(datos_array[i], $('tr.editar'), i);
                }

                $('#tablaConexion tr').each(function () {
                    $(this).removeClass("editar");
                });

            }else{
                 var data = {
                    'id_detalle'        :   '',
                    'codigo_contexto'   :   codigo,
                    'host'              :   host,
                    'url'               :   url,
                    'puerto'            :   puerto
                };

                lista_conexion.push(data);
                tabla_conexion.row.add(row).draw();

            }

            limpia_imput();

        }else{
            clear_errors_form('#form_parametro_facturacion');

            for (var i in errores){
                 error_ul = "<ul class='errorlist'><li>"+errores[i].value+"</li></ul>";
                $("#id_" + errores[i].key).parent().find('.container-error').append(error_ul);
            }
        }
    }


    function editar_conexion(row) {

        var codigo  =  $(row).parent().parent().find('td').eq(0).html();
        var host    =  $(row).parent().parent().find('td').eq(1).html();
        var url     =  $(row).parent().parent().find('td').eq(2).html();
        var puerto  =  $(row).parent().parent().find('td').eq(3).html();


        $('#tablaConexion tr').each(function () {
            $(this).removeClass("editar");
        });

        $(row).parent().parent().addClass('editar');

        if($(row).parent().parent().hasClass('original')){
            cabecera = "original";
        }else{
            cabecera = '';
        }

        var rowindex = $(row).parent().parent().parent().children().index($(row).parent().parent());
        $(row).parent().parent().attr('id',rowindex);

        $('#id_codigo_contexto').val(codigo);
        $('#id_host').val(host);
        $('#id_url').val(url);
        $('#id_puerto').val(puerto);
    }

    function elimina_conexion(row) {
        var rowindex    = $(row).parent().parent().parent().children().index($(row).parent().parent());
        var id_detalle  = lista_conexion[parseInt(rowindex)].id_detalle;

        var col     = $(row).closest('tr');

        if($(row).parent().parent().hasClass('nueva')){
            if($(row).parent().parent().hasClass('original')){
                var data ={
                    id_detalle  : id_detalle,
                    borrar      : true
                };
                lista_conexion[rowindex]=data;
            }else{
                lista_conexion.splice(rowindex,1);
            }

            tabla_conexion.row($(col)).remove().draw();

        }else {
            if($(row).parent().parent().hasClass('original')){
                var data ={
                    id_detalle  : id_detalle,
                    borrar      : true
                };
                lista_conexion[rowindex]=data;
            }else{
                lista_conexion.splice(rowindex,1);
            }

            tabla_conexion.row($(col)).remove().draw();

        }
    }

    function valida_detalle(codigo, host, url, puerto) {
        errores     =   [];
        var flag    =   true;

        if (codigo == ''){
            var error = 'Este campo es obligatorio.';
            errores.push({
                key     : 'codigo_contexto',
                value   : error
            });
            flag=false;
        }
         if (host == ''){
            var error = 'Este campo es obligatorio.';
            errores.push({
                key     : 'host',
                value   : error
            });
            flag=false;
        }
         if (url == ''){
            var error = 'Este campo es obligatorio.';
            errores.push({
                key     : 'url',
                value   : error
            });
            flag=false;
        }
         if (puerto == ''){
            var error = 'Este campo es obligatorio.';
            errores.push({
                key     : 'puerto',
                value   : error
            });
            flag=false;
        }
        return flag;
    }

    function limpia_imput() {
        $('#id_codigo_contexto').val('');
        $('#id_host').val('');
        $('#id_url').val('');
        $('#id_puerto').val('');
        clear_errors_form('#form_parametro_facturacion');
    }

    function enviar_form(form){
        var id_parametro = {{ id }} ;
        var data = {
            id_parametro        :   id_parametro,
            detalle_conexion    :   JSON.stringify(lista_conexion),
            persona             :   parseInt($('#id_persona').val()),
            codigo_conexion     :   $('#id_codigo_conexion').val(),
            motor_emision       :   $('#id_motor_emision').find("option:selected").val()
        };
        $.ajax({
            type: 'post',
            url: '{% url 'facturacion:editar_configuracion' pk=id %}',
            data: data,
            success: function(response) {
                if(response.success==true){
                    clear_errors_form('#'+form);
                    swal({
                        title: "Exito!",
                        text: "Configuración editada correctamente",
                        type: "success",
                    });
                    window.location.href='{% url 'facturacion:visualizar_configuracion' %}';
                }else{
                    swal({
                        title: "Error!",
                        text: response.error,
                        type: "error",
                        confirmButtonText: "Ok"
                    });
                }
{#                if (accion == 'create') {#}
{#                    clear_form('#form_parametro_facturacion')#}
{#                }#}
{#                clear_errors_form('#form_parametro_facturacion');#}
{##}
{#                notification_toast('success', 'ÉXITO', 'Guardado correctamente.')#}
            },
            error: function(data, textStatus, jqXHR) {
                clear_errors_form('#form_parametro_facturacion');
                var errors = $.parseJSON(data.responseText);
                apply_errors_form(errors);
                var body = $("html, body");
                body.stop().animate({scrollTop:0}, '500', 'swing', function() { });
            }
        });
        return false;
    }

    function recuperaDataParametros() {
        $.ajax({
            url:'{% url 'facturacion:recupera_data_parametros' pk=id %}',
            type:'POST',
            data:'',
            success: function (response) {
                var rows            = [];

                for (var a in response.lista_detalle){

                    var row = {};

                    row.codigo_contexto     =   response.lista_detalle[a].codigo_contexto;
                    row.host                =   response.lista_detalle[a].host;
                    row.url                 =   response.lista_detalle[a].url;
                    row.puerto              =   response.lista_detalle[a].puerto;
                    row.options             =   '<td class="text-center"><a class="btn btn-success btn-xs" onclick="editar_conexion(this)" title="Editar"><i class="fa fa-edit"></i></a>  <a class="btn btn-danger btn-xs" onclick="elimina_conexion(this)" title="Eliminar"><i class="fa fa-trash "></i></a></td>';


                    rows.push(row);

                    var data ={
                        'id_detalle'            : response.lista_detalle[a].id_detalle,
                        'codigo_contexto'       : response.lista_detalle[a].codigo_contexto,
                        'host'                  : response.lista_detalle[a].host,
                        'url'                   : response.lista_detalle[a].url,
                        'puerto'                : response.lista_detalle[a].puerto,
                        'borrar'                : false
                    };

                    lista_conexion.push(data);
                }
                tabla_conexion.rows.add(rows).draw();
                $("#tablaConexion").find("tbody tr").addClass('original');

            },
            error:function (x,a,y) {
                swal({
                    title:"Error!",
                    text:"Error al recuperar detalle del documento",
                    type:"error",
                    confirmButtonText:"OK"
                });
                console.log(x,a,y);
            }
        });
    }

</script>
{% endblock %}