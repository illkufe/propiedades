{% extends 'index.html' %}
{% block section %}
{% load extra_tags %}
{% load static %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">

				<form id="form-venta-new" role="form" action="/ventas/" method="post" enctype="multipart/form-data">
					{% csrf_token %}

					<div class="ibox-title">
						<h5>Subir Plantilla de Ventas</h5>
                        <div class="ibox-tools">
                            <a href="/media/formatos/formato_ventas.xls" class="btn btn-primary btn-xs" role="button"><i class="fa fa-download"></i>
                                Descargar Plantilla
                            </a>
                        </div>
					</div>

					<div class="ibox-content">
						<div class="row">

							<div class="col-sm-12">
								<div class="row">

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="..."></i>
										<label>Local:</label>
										<select name="local" class="form-control">
											<option value="">---------</option>
											{% for local in locales %}
											<option value="{{ local.id }}">{{ local.nombre }}</option>
											{% endfor %}
										</select>
										<div class="container-error"></div>
									</div>

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.fecha_plazo.help_text }}" ></i>
										<label for="">Periodicidad</label>
										<select name="periodicidad" class="form-control valid" aria-invalid="false">
											<option value="">-------------</option>
											<option value="1">Mensual</option>
											<option value="2">Diaria</option>
										</select>
										<div class="container-error">
										</div>
									</div>

									<div class="form-group col-sm-4">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.valor_cuota.help_text }}" ></i>
										<label for="">Archivo</label>
										<input type="file" id="file" name="file" class="filestyle" data-buttonText="" accept="application/vnd.ms-excel" >
										<div class="container-error">
										</div>
									</div>

									<div class="form-group col-sm-2">
										<p style="color:#fff; margin-bottom:6px">.</p>
										<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">SUBIR ARCHIVO</button>
									</div>

								</div>
							</div>
						</div>
					</div>
				</form>

				<div class="ibox-title">
					<h5>Lista de Ventas</h5>
				</div>

				<div class="ibox-content">
					<div class="row">
						<div class="col-sm-12">
							<div class="table-responsive">
								<table id="tabla-ventas" class="table table-striped table-bordered table-hover" style="width:100%;">
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal inmodal fade" id="modalError" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Archivo Cargado</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <p class="text-center">
                    <button type="button" class="btn btn-w-m btn-sm btn-primary" data-dismiss="modal">OK</button>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock section %}

{% block scripts %}
<script>

var tabla_ventas = []

$(document).ready(function(){

	var columns = [
	{		
		'data': 'id',
		'title': 'ID',
		'visible': false,
	},
	{
		'width': '15%',
		'data': 'local',
		'title': 'Local',
	},
	{
		'width': '15%',
		'data': 'mes',
		'title': 'Mes',
	},
	{
		'width': '15%',
		'data': 'ano',
		'title': 'AÃ±o',
	},
	{
		'width': '15%',
		'data': 'total',
		'title': 'Total',
	},
	{
		'width': '5%',
		'data': 'options',
		'orderable': false,
		'title': '<div class="text-center">Opciones</div>',
	}]

	tabla_ventas = load_table('#tabla-ventas', columns, {})

	load_tabla_ventas()

	$("#file").filestyle({buttonText: "Find file"});

	guardar_ventas()

});

function guardar_ventas(){
	$("#form-venta-new").validate({
		rules: {
			local: {
				required: true,
			},
			periodicidad: {
				required: true,
			},
			file: {
				required: true,
			},
		},
		messages: {
			local: {
				required: "campo requerido",
			},
			periodicidad: {
				required: "campo requerido",
			},
			file: {
				required: "campo requerido",
			},
		},
		errorPlacement: function(error, element) {
			error.appendTo(element.closest(".form-group").find('.container-error'));
		},
		submitHandler: function(form) {

			$('#form-venta-new').ajaxSubmit({
				dataType: 'json',
				beforeSubmit: function(){
					console.log('enviando')
				},
				success: function(data){
					console.log(data)
					if (data.estado == 'error') {
						var template = ''
                        template += '<div class="row">'
                        template += '<div class="text-center">'
                        template += '<p style="color:#ff8100; font-size:100px">'
                        template += '<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>'
                        template += '</p>'
						template += '<h4>Error en los siguientes datos</h4>'
                        template += '</div>'
                        template += '<br>'
						template += '<table class="table table-striped table-bordered table-hover">'
						template += '<thead>'
						template += '<tr>'
						template += '<th>fila</th>'
						template += '<th>fecha inicio</th>'
						template += '<th>fecha termino</th>'
						template += '<th>valor</th>'
                        template += '<th>error</th>'
						template += '</tr>'
						template += '</thead>'
						template += '<tbody>'

						for (var i = 0; i < data.errors.length; i++) {
							template += '<tr>'
							template += '<td>'+data.errors[i].row+'</td>'
							template += '<td>'+data.errors[i].fecha_inicio+'</td>'
							template += '<td>'+data.errors[i].fecha_termino+'</td>'
							template += '<td>'+data.errors[i].valor+'</td>'

                            var template_error = ''
                            for(var a = 0; a < data.errors[i].error.length; a++){
                                template_error += '<p>'+data.errors[i].error[a]+'</p>'
                            }
                            template += '<td>'+template_error+'</td>'
							template += '</tr>'
						};

						template += '</tbody></table></div>'
					}else{
                        var template = ''
                        template += '<div class="row">'
                        template += '<div class="text-center">'
                        template += '<p style="color:#a5dc86; font-size:100px">'
                        template += '<i class="fa fa-check-circle" aria-hidden="true"></i>'
                        template += '</p>'
						template += '<p style="font-size: 20px;font-weight: bold">OK</p>'
                        template += '</div>'
					}


                    $('#modalError').find('.modal-body').html(template);
                    $('#modalError').modal('show');


					load_tabla_ventas()

					clear_form('#form-venta-new')
					$("#file").filestyle('clear');

				}
			})

}
}) 
}

function load_tabla_ventas(){

	tabla_ventas.clear().draw();

	$.ajax({
		url: '/ventas/',
		type: 'get',
		dataType: 'json',
		success: function(data){
			rows = [];

			for (var i = 0; i < data.length; i++) {

				row = {}

				row.id 		= 1
				row.local 	= data[i].local_nombre
				row.mes 	= data[i].mes
				row.ano 	= data[i].ano
				row.total 	= data[i].valor
				row.options = '<div class="text-center"><a class="btn btn-delete btn-bitbucket"><i class="fa fa-trash"></i></a></div>'

				rows.push(row)
			};

			tabla_ventas.rows.add(rows).draw();
		}
	})
}

</script>

{% endblock scripts %}


