{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content generar-propuesta animated fadeInUp">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins filtrar-contratos">
				<div class="ibox-title">
					<h5>Filtrar Contratos</h5>
					<div class="ibox-tools">
						<a class="collapse-link">
							<i class="fa fa-chevron-up"></i>
						</a>
					</div>
				</div>
				<form id="form-fitrar-contratos" role="form" action='{% url "propuesta_filtrar" %}' method="POST">
					{% csrf_token %}

					<div class="ibox-content" style="display: block;">
						<div class="row">
							<div class="form-group col-sm-3">
								<div>
									<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="..."></i>
									<label>Periodo: Mes/Año</label>
								</div>
								<div style="float:left; width:60%">
									<select class="form-control" name="mes">
										<option value="">---------</option>
										<option value="1">Enero</option>
										<option value="2">Febrero</option>
										<option value="3">Marzo</option>
										<option value="4">Abril</option>
										<option value="5">Mayo</option>
										<option value="6">Junio</option>
										<option value="7">Julio</option>
										<option value="8">Agosto</option>
										<option value="9">Septiembre</option>
										<option value="10">Octubre</option>
										<option value="11">Noviembre</option>
										<option value="12">Diciembre</option>
									</select>
								</div>
								<div style="float:left; width:35%; margin-left:4%;">
									<input type="number" class="form-control" name="anio">
								</div>
								<div class="container-error"></div>
							</div>
							<div class="form-group col-sm-3">
								<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="..."></i>
								<label>Activo:</label>
								<select name="activo" class="form-control">
									<option value="">---------</option>
									{% for activo in activos %}
									<option value="{{ activo.id }}">{{ activo.nombre }}</option>
									{% endfor %}
								</select>
								<div class="container-error"></div>
							</div>
							<div class="form-group col-sm-6">
								<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="..."></i>
								<label>Conceptos:</label>
								<select name="conceptos" class="form-control select2" multiple="multiple">
									{% for concepto in conceptos %}
									<option value="{{ concepto.id }}">{{ concepto.nombre }}</option>
									{% endfor %}
								</select>
								<div class="container-error"></div>
							</div>
						</div>

						<div class="row">
							<div class="col-xs-12">
								<button type="submit" class="btn btn-primary btn-sm btn-w-m pull-right">ACEPTAR</button>
							</div>
						</div>

					</div>
				</form>
			</div>

			<div class="ibox float-e-margins seleccionar-contratos">
				<div class="ibox-title">
					<h5>Seleccionar Contratos</h5>
					<div class="ibox-tools">
						<a class="collapse-link">
							<i class="fa fa-chevron-up"></i>
						</a>
					</div>
				</div>

				<form id="form-generar-propuesta" class="hide" action='{% url "propuesta_generar" %}' method="POST">
					{% csrf_token %}
					<input type="hidden" name="mes">
					<input type="hidden" name="anio">
					<input type="hidden" name="conceptos">
					<input type="hidden" name="contratos">

					<div class="ibox-content" style="display: block;">
						<div class="row">
							<div class="col-xs-12">
								<div class="table-responsive">
									<table id="tabla-contratos" class="table table-striped table-hover"></table>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12">
								<button type="button" class="btn btn-primary btn-sm btn-w-m pull-right" onclick="crear_propuesta()">ACEPTAR</button>
							</div>
						</div>
					</div>
				</form>
			</div>

			<div class="ibox float-e-margins validar-propuesta">

				<div class="ibox-title">
					<h5>Validar Propuesta</h5>
					<div class="ibox-tools">
						<a class="collapse-link">
							<i class="fa fa-chevron-up"></i>
						</a>
					</div>
				</div>

				<form id="validar-propuesta" class="hide">
					<div id="container-propuesta"></div>
					<div class="ibox-content" style="display: block;">
						<div class="row">
							<div class="col-xs-12">
								<button type="submit" class="btn btn-primary btn-sm btn-w-m pull-right">ACEPTAR</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<style>
.generar-propuesta .validar-propuesta .contrato-informacion{
	margin-top: 10px;
}

.generar-propuesta .validar-propuesta .contrato-informacion p{
	margin: 0 0 1px;
	font-weight: 300;
}

.generar-propuesta .validar-propuesta .contrato-informacion p span:first-child{
	font-weight: normal;
	display: inline-block;
	min-width: 110px;
}

.generar-propuesta .validar-propuesta .contrato-informacion p span:last-child::before{
	content: ':';
	padding: 0 10px;
}

.generar-propuesta .validar-propuesta .container-tabla{
	margin-top: 20px;
}

.generar-propuesta .validar-propuesta .container-tabla table tr td:first-child{
	width: 75%;
}

.generar-propuesta .validar-propuesta .container-tabla table tr td:last-child{
	width: 25%;
}

.generar-propuesta .validar-propuesta .container-tabla table tr td input{
	width: 100%
}
</style>

{% endblock section %}

{% block scripts %}

<script>

var tabla_contratos;

$(document).ready(function(){

	initialize()
	filtrar_contratos()

});

function initialize(){

	var fecha = new Date();

	$('#form-fitrar-contratos select[name="mes"]').val(fecha.getMonth() + 1)
	$('#form-fitrar-contratos input[name="anio"]').val(fecha.getFullYear())

}



// seccion filtrar contratos
function filtrar_contratos(){
	$("#form-fitrar-contratos").validate({
		rules: {
			mes: {
				required: true,
			},
			anio: {
				required: true,
			},
			activo: {
				required: true,
			},
			conceptos: {
				required: true,
			},
		},
		messages: {
			mes: {
				required: "campo requerido",
			},
			anio: {
				required: "campo requerido",
			},
			activo: {
				required: "campo requerido",
			},
			conceptos: {
				required: "campo requerido",
			}
		},
		errorPlacement: function(error, element) {
			error.appendTo(element.closest(".form-group").find('.container-error'));
		},
		submitHandler: function(form) {
			$('#form-fitrar-contratos').ajaxSubmit({
				dataType: 'json',
				success: function(data){

					$('#form-generar-propuesta input[name="mes"]').val($('#form-fitrar-contratos select[name="mes"]').val())
					$('#form-generar-propuesta input[name="anio"]').val($('#form-fitrar-contratos input[name="anio"]').val())
					$('#form-generar-propuesta input[name="conceptos"]').val($('#form-fitrar-contratos select[name="conceptos"]').val())

					if (data.length > 0) {
						$('.seleccionar-contratos #form-generar-propuesta').removeClass('hide')
						load_tabla_contratos(data[0].conceptos)
						data_tabla_contratos(data)
						$('[data-toggle="tooltip"]').tooltip()
					}else{
						$('.seleccionar-contratos #form-generar-propuesta').addClass('hide')
						var configuracion = {
							'toast_type'	: 'error',
							'toast_text' 	: 'no se encontraron contratos',
							'toast_title' 	: 'Advertencia',
						}
						notification_toast_final(configuracion)
					}
				}
			})
		}
	})
}

function load_tabla_contratos(conceptos){

	if ($.fn.DataTable.isDataTable( '#tabla-contratos')){
		tabla_contratos.destroy();
		$('.seleccionar-contratos table#tabla-contratos').html('')
	}

	var configuracion = {
		'order'			: [[1, 'desc']],
		'paginate'		: false,
		'bLengthChange'	: false,
		'bInfo'			: false,
		'searching'		: false,
		'buttons'		: [],
	} 

	var columns = [
	{
		'width'		: '5%',
		'data'		: 'opciones',
		'orderable'	: false,
		'title'		: '<div class="text-center"><input type="checkbox" class="checkbox-all" onchange="seleccionar_todo(this)"></div>',
	},
	{
		'width'	: '15%',
		'data'	: 'numero',
		'title'	: 'Nº Contrato',
	},
	{
		'width'		: '15%',
		'data'		: 'nombre',
		'title'		: 'Nombre',
		'visible'	: false,
	},
	{
		'width'	: '15%',
		'data'	: 'cliente',
		'title'	: 'Cliente',
	}];

	var columnas = []

	for (var i = 0; i < conceptos.length; i++) {

		columna = {}

		columna.data 		= conceptos[i].id
		columna.title 		= '<div class="text-center">'+conceptos[i].codigo.toLowerCase()+'</div>'
		columna.orderable 	= false
		columna.width 		= '7%',

		columns.push(columna)
	};

	tabla_contratos = load_table('#tabla-contratos', columns, configuracion)
}

function data_tabla_contratos(data){

	tabla_contratos.clear().draw();

	rows = [];

	for (var i = 0; i < data.length; i++) {
		
		row = {}

		row['opciones'] = '<div class="text-center"><input type="checkbox" class="checkbox-contrato" value="'+data[i].id+'" onchange="seleccionar_uno()"></div>'
		row['numero']	= data[i].numero
		row['nombre']	= data[i].nombre
		row['cliente']	= data[i].cliente

		for (var j = 0; j < data[i].conceptos.length; j++) {
			var template = ''
			template += '<div class="text-center">'
			if (data[i].conceptos[j].valido.estado == true) {
				template += '<i class="fa fa-check-circle info-label"></i>'
			}else{
				template += '<i class="fa fa-times-circle info-label" data-toggle="tooltip" data-placement="top" title="" data-original-title="'+data[i].conceptos[j].valido.mensaje+'"></i>'
			}

			template += '</div>'
			row[data[i].conceptos[j].id] = template
			// row[data[i].conceptos[j].id] = data[i].conceptos[j].valido.estado
		}
		rows.push(row)
	}

	tabla_contratos.rows.add(rows).draw();
}



// sección seleccionar contratos
function crear_propuesta(){

	var contratos 		= []
	var tabla_contratos = $('#tabla-contratos').dataTable();
	var enviar 			= false

	$('.checkbox-contrato:checked', tabla_contratos.fnGetNodes()).each(function(i){
		contratos.push($(this).val())
		enviar = true
	})

	$('#form-generar-propuesta input[name="contratos"]').val(contratos)

	if (enviar) {
		$('#form-generar-propuesta').ajaxSubmit({
			dataType: 'json',
			success: function(data){
				cargar_propuesta(data)
			}
		});
	}else{
		var configuracion = {
			'toast_type'	: 'error',
			'toast_text' 	: 'seleccionar al menos un contrato',
			'toast_title' 	: 'Advertencia',
		}
		notification_toast_final(configuracion)
	}
}

function seleccionar_uno(){

	$('.checkbox-all').prop('checked', false)
}

function seleccionar_todo(obj){

	var all 	= false
	var tabla 	= $('#tabla-contratos').dataTable();

	if($(obj).is(':checked')){
		all = true
	}

	$('.checkbox-contrato', tabla.fnGetNodes()).each(function(i){
		$(this).prop('checked', all)
	})
}



// sección generar propuesta
function cargar_propuesta(contratos){

	$('#validar-propuesta').removeClass('hide')
	$('#container-propuesta').html('')

	for (var i = 0; i < contratos.length; i++) {
		$('#container-propuesta').append(template_propuesta(contratos[i]))
	}

	validar_form_propuesta()
}

function template_propuesta(contrato){

	var template = ''

	template += '<div data-id="@contrato_id" class="ibox-content" style="display: block;">'

	template += '<div class="contrato-informacion">'
	template += '<p><span>Nº Contrato</span><span>@contrato_numero</span></p>'
	template += '<p><span>Cliente</span><span>@cliente_nombre</span></p>'
	template += '<p><span>RUT</span><span>@cliente_rut</span></p>'
	template += '<p><span>Marca comercial</span><span>@contrato_nombre</span></p>'
	template += '</div>'

	template += '<div class="container-tabla">'
	template += '<table id="tabla-conceptos-@contrato_id" class="table table-striped">'
	template += '<thead>'
	template += '<tr>'
	template += '<th>concepto a facturar</th>'
	template += '<th class="text-right">total ($)</th>'
	template += '</tr>'
	template += '</thead>'
	template += '<tbody>'

	for (var i = 0; i < contrato.conceptos.length; i++) {

		template += '<tr>'
		template += '<input type="hidden" class="id" value="@concepto_id">'
		template += '<td><input type="text" class="nombre"  name="nombre-@contrato_id-@concepto_id" value="@concepto_nombre"><div class="container-error"></div></td>'
		template += '<td><input type="number" class="total" name="total-@contrato_id-@concepto_id"  value="@concepto_total"><div class="container-error"></div></td>'
		template += '</tr>'

		template = template.replace(/@concepto_id/g, 		contrato.conceptos[i].id);
		template = template.replace(/@concepto_nombre/g, 	contrato.conceptos[i].nombre);
		template = template.replace(/@concepto_total/g, 	contrato.conceptos[i].total);
	};

	template += '</tbody>'
	template += '</table>'
	template += '</div>'
	template += '</div>'

	template = template.replace(/@contrato_id/g, 		contrato.id);
	template = template.replace(/@contrato_numero/g, 	contrato.numero);
	template = template.replace(/@cliente_nombre/g, 	contrato.nombre);
	template = template.replace(/@cliente_rut/g, 		contrato.cliente.rut);
	template = template.replace(/@contrato_nombre/g, 	contrato.cliente.nombre);

	return template
}

function validar_form_propuesta(){

	$("#validar-propuesta").validate({

		errorPlacement: function(error, element) {
			error.appendTo(element.closest("td").find('.container-error'));
		},
		submitHandler: function(form) {
			var data = []

			// armar data
			$("#container-propuesta .ibox-content").each(function (index){

				var contrato 		= {}
				contrato.id 		=  $(this).data("id")
				contrato.conceptos 	=  []

				$('#tabla-conceptos-'+contrato.id+' > tbody > tr').each(function(){

					var concepto = {}

					concepto.id 		= $(this).find('input.id').val()
					concepto.nombre 	= $(this).find('input.nombre').val()
					concepto.total 		= $(this).find('input.total').val()
					concepto.modified 	= false

					contrato.conceptos.push(concepto)

				});

				data.push(contrato)
			})

			// enviar data
			$.ajax({
				url: '/procesos/propuesta/guardar',
				type: 'post',
				dataType: 'json',
				data:{
					mes 				: $('#form-generar-propuesta input[name="mes"]').val(),
					anio 				: $('#form-generar-propuesta input[name="anio"]').val(),
					contratos 			: JSON.stringify(data),
					csrfmiddlewaretoken : getCookie('csrftoken'),
				},
				beforeSend: function(){
					// $('.validar-propuesta button').attr('disabled', true)
					// <i class="fa fa-spinner fa-pulse fa-fw"></i>
				},
				success: function(data){
					// $('.validar-propuesta #container-propuesta').html('')
					// $('.validar-propuesta button').attr('disabled', false)
					// $('.validar-propuesta button').addClass('hide')
					swal({
						title 	: 'Propuesta Creada',
						text 	: '',
						type 	: 'success',
						showCancelButton 	: true,
						confirmButtonColor 	: '#FCC491',
						// confirmButtonText 	: '<a href="/procesos/propuesta/pdf/152"><span style="color:#FFF">Descargar PDF<span>',
						confirmButtonText 	: '<a>Descargar PDF</a>',
						cancelButtonText 	: '<a href="/propuesta/generar/list"><span style="color:#FFF">Nueva Propuesta</span></a>',
						allowOutsideClick 	: false,
						allowEscapeKey 		: false,
					}).then(function() {
						console.log('asd')
					})







					swal({
						title 	: 'Propuesta Creada',
						text 	: '',
						type 	: 'success',
						showCancelButton 	: true,
						confirmButtonColor 	: '#FCC491',
						confirmButtonText 	: '<a>Descargar PDF</a>',
						cancelButtonText 	: '<a href="/propuesta/generar/list"><span style="color:#FFF">Nueva Propuesta</span></a>',
						allowOutsideClick 	: false,
						allowEscapeKey 		: false,
						allowOutsideClick: false
					}).then(function() {
						console.log('asd')
					})


				}
			})
		}
	})

	// agregar validacion a los campos nombre
	$("[name^=nombre]").each(function () {
		$(this).rules("add", {
			required: true,
			messages: {
				required: "campo requerido",
			}
		});
	});

	// agregar validacion a los campos nombre
	$("[name^=total]").each(function () {
		$(this).rules("add", {
			required: true,
			messages: {
				required: "campo requerido",
			}
		});
	});
}


</script>

{% endblock scripts %}


