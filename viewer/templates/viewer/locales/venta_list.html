{% extends 'index.html' %}
{% block section %}

{% include 'partials/breadcrumbs-bar.html' %}

<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">

				<form id="form-venta-new" role="form" action="/ventas/" method="post" enctype="multipart/form-data">
					{% csrf_token %}

					<div class="ibox-title">
						<h5>Subir Plantilla de Ventas</h5>
					</div>

					<div class="ibox-content">
						<div class="row">
							<div class="col-sm-12">
								<div class="row">

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="..."></i>
										<label>Activo:</label>
										<select name="local" class="form-control">
											<option value="">---------</option>
											{% for local in locales %}
											<option value="{{ local.id }}">{{ local.nombre }}</option>
											{% endfor %}
										</select>
										<div class="container-error"></div>
									</div>

									<div class="form-group col-sm-3">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.fecha_plazo.help_text }}" ></i>
										<label for="">Periodicidad</label>
										<select name="periodicidad" class="form-control valid" aria-invalid="false">
											<option value="">-------------</option>
											<option value="1">Mensual</option>
											<option value="2">Diaria</option>
										</select>
										<div class="container-error">
										</div>
									</div>

									<div class="form-group col-sm-4">
										<i class="fa fa-question-circle info-label" data-toggle="tooltip" data-placement="top" title="{{ form.valor_cuota.help_text }}" ></i>
										<label for="">Archivo</label>
										<input type="file" id="file" name="file" class="filestyle" data-buttonText="" accept="application/vnd.ms-excel , .csv" >
										<div class="container-error">
										</div>
									</div>

									<div class="form-group col-sm-2">
										<p style="color:#fff; margin-bottom:6px">.</p>
										<button class="btn btn-w-m btn-sm btn-primary pull-right" type="submit">SUBIR ARCHIVO</button>
									</div>

								</div>
							</div>
						</div>
					</div>
				</form>

				<div class="ibox-title">
					<h5>Lista de Ventas</h5>
				</div>

				<div class="ibox-content">
					<div class="row">
						<div class="col-sm-12">
							<div class="table-responsive">
								<table id="tabla-ventas" class="table table-striped table-bordered table-hover dataTables-example" >
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock section %}

{% block scripts %}
<script>
var tabla_ventas = []

$(document).ready(function(){	

	var columns = [
	{		
		'data': 'id',
		'title': 'ID',
		'visible': false,
	},
	{
		'width': '15%',
		'data': 'local',
		'title': 'Local',
	},
	{
		'width': '15%',
		'data': 'mes',
		'title': 'Mes',
	},
	{
		'width': '15%',
		'data': 'ano',
		'title': 'AÃ±o',
	},
	{
		'width': '15%',
		'data': 'total',
		'title': 'Total',
	},
	{
		'width': '10%',
		'data': 'options',
		'orderable': false,
	}]

	tabla_ventas = load_table('#tabla-ventas', columns, {})

	load_tabla_ventas()

	$("#file").filestyle({buttonText: "Find file"});

	guardar_ventas()

});



function guardar_ventas(){
	$("#form-venta-new").validate({
		rules: {
			local: {
				required: true,
			},
			periodicidad: {
				required: true,
			},
			file: {
				required: true,
			},
		},
		messages: {
			local: {
				required: "campo requerido",
			},
			periodicidad: {
				required: "campo requerido",
			},
			file: {
				required: "campo requerido",
			},
		},
		errorPlacement: function(error, element) {
			error.appendTo(element.closest(".form-group").find('.container-error'));
		},
		submitHandler: function(form) {

			$('#form-venta-new').ajaxSubmit({
				dataType: 'json',
				beforeSubmit: function(){
					console.log('enviando')
				},
				success: function(data){
					console.log(data)
					if (data.estado == 'error') {
						var template = ''
						template += '<p>Error en los siguientes datos</p>'
						template += '<table class="table table-striped table-bordered table-hover">'
						template += '<thead>'
						template += '<tr>'
						template += '<th>fila</th>'
						template += '<th>fecha inicio</th>'
						template += '<th>fecha termino</th>'
						template += '<th>valor</th>'
						template += '</tr>'
						template += '</thead>'
						template += '<tbody>'

						for (var i = 0; i < data.errors.length; i++) {
							template += '<tr>'
							template += '<td>'+data.errors[i].row+'</td>'
							template += '<td>'+data.errors[i].fecha_inicio+'</td>'
							template += '<td>'+data.errors[i].fecha_termino+'</td>'
							template += '<td>'+data.errors[i].valor+'</td>'
							template += '</tr>'
						};

						template += '</tbody></table>'
					}else{
						template = 'OK'
					}


					swal({
						title: "Archivo <small>cargado</small>",
						text: template,
						type: "success",
						html: true
					});

					load_tabla_ventas()

					clear_form('#form-venta-new')
					$("#file").filestyle('clear');

				}
			})

		}
	}) 
}

// function guardar_ventas(){
// 	$('#form-venta-new').ajaxSubmit({
// 		dataType: 'json',
// 		beforeSubmit: function(){
// 			console.log('enviando')
// 		},
// 		success: function(data){
// 			console.log(data)
// 			if (data.estado == 'error') {
// 				var template = ''
// 				template += '<p>Error en los siguientes datos</p>'
// 				template += '<table class="table table-striped table-bordered table-hover">'
// 				template += '<thead>'
// 				template += '<tr>'
// 				template += '<th>fila</th>'
// 				template += '<th>fecha inicio</th>'
// 				template += '<th>fecha termino</th>'
// 				template += '<th>valor</th>'
// 				template += '</tr>'
// 				template += '</thead>'
// 				template += '<tbody>'

// 				for (var i = 0; i < data.errors.length; i++) {
// 					template += '<tr>'
// 					template += '<td>'+data.errors[i].row+'</td>'
// 					template += '<td>'+data.errors[i].fecha_inicio+'</td>'
// 					template += '<td>'+data.errors[i].fecha_termino+'</td>'
// 					template += '<td>'+data.errors[i].valor+'</td>'
// 					template += '</tr>'
// 				};

// 				template += '</tbody></table>'
// 			}else{
// 				template = 'OK'
// 			}


// 			swal({
// 				title: "Archivo <small>cargado</small>",
// 				text: template,
// 				type: "success",
// 				html: true
// 			});

// 			load_tabla_ventas()

// 			//limpiar formulario

// 		}
// 	})
// }

function load_tabla_ventas(){

	tabla_ventas.clear().draw();

	$.ajax({
		url: '/ventas/',
		type: 'get',
		dataType: 'json',
		success: function(data){
			rows = [];

			for (var i = 0; i < data.length; i++) {

				row = {}
				row.id 		= 1
				row.local 	= data[i].local_nombre
				row.mes 	= data[i].mes
				row.ano 	= data[i].ano
				row.total 	= data[i].valor
				row.options = '<div class="text-center"><a class="btn btn-delete btn-bitbucket"><i class="fa fa-trash"></i></a></div>'

				rows.push(row)
			};

			tabla_ventas.rows.add(rows).draw();
		}
	})
}

</script>

{% endblock scripts %}


